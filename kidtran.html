<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Miss K English class</title>
<style>
:root{
  --kids-bg:#FFF7CC; --kids-panel:#FFE680; --kids-panel-2:#FFEF99;
  --kids-accent:#FFB703; --kids-accent-2:#FB8500; --kids-text:#3A2D00;
  --kids-muted:#6B5600; --kids-border:#FFD259; --kids-shadow:0 6px 18px rgba(160,120,0,.18);
  --kids-radius:12px;
}
body{
  background:var(--kids-bg); color:var(--kids-text);
  font-family:"Comic Sans MS","Noto Sans TC","Microsoft JhengHei",system-ui,Arial,sans-serif;
  line-height:1.6; padding-bottom:110px;
}
header{ background:linear-gradient(180deg,var(--kids-panel),var(--kids-panel-2));
  border-bottom:2px dashed var(--kids-border); box-shadow:var(--kids-shadow);
  padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
h1{ color:var(--kids-text); font-size:18px; margin:0; } h1::before{ content:"ğŸ¦"; margin-right:6px; }
.btn{ padding:10px 14px; border:2px solid var(--kids-border); border-radius:20px;
  background:#fff8d9; color:#3A2D00; box-shadow:var(--kids-shadow); font-weight:700; }
.btn.primary{ background:var(--kids-accent); border-color:var(--kids-accent-2); color:#1b1100; }
textarea{ width:100%; height:220px; border-radius:14px; border:2px solid var(--kids-border);
  background:#fffef5; color:#3A2D00; font-size:15px; padding:10px; }
#status{ border:2px dashed var(--kids-border); border-radius:var(--kids-radius);
  background:#fff7d1; color:#3A2D00; box-shadow:var(--kids-shadow); padding:12px; margin:18px; }
.grid{ display:grid; gap:14px; margin:18px; } @media (min-width:800px){ .grid{ grid-template-columns:1fr 1fr; } }
.panel{ background:#fffbea; border:2px solid var(--kids-border); border-radius:var(--kids-radius);
  padding:14px; box-shadow:var(--kids-shadow); }
label{ display:block; margin-bottom:8px; font-weight:900; color:#6B5600; }

/* é«˜äº®å·®ç•° */
.hl-del{ background:#ffe3e3; text-decoration:line-through; border-radius:6px; padding:0 4px; }
.hl-ins{ background:#ddf8dd; border-bottom:2px solid #2d8a2d; border-radius:6px; padding:0 4px; }
.small{ font-size:13px; color:#5f4b00; }

/* ä¿®æ­£ç´°ç¯€å¡ç‰‡ */
#review{ display:none; margin:18px; }
#review .card{ background:#fffef5; border:2px solid var(--kids-border); border-radius:var(--kids-radius); padding:14px; box-shadow:var(--kids-shadow); }
.suggest{ margin:8px 0 0 22px; }
.suggest li{ margin:10px 0; }
.chip-old{ background:#ffe3e3; border-radius:6px; padding:0 6px; }
.chip-new{ background:#ddf8dd; border-radius:6px; padding:0 6px; border-bottom:2px solid #2d8a2d; }

/* å³ä¸‹è²¼ç´™ï¼ˆä¸æ“‹é»æ“Šï¼‰ */
body::after{
  content:" ğŸ»ğŸ°ğŸ¦Š ä¸€èµ·å­¸Englishï¼ ";
  position:fixed; right:10px; bottom:8px;
  background:#fff; border:2px solid var(--kids-border); border-radius:14px;
  padding:8px 10px; box-shadow:var(--kids-shadow);
  font-weight:800; color:#3A2D00;
  transform:scale(.9); pointer-events:none;
}
</style>
</head>
<body>
<header>
  <h1>Miss K English class</h1>
</header>

<div class="grid">
  <div class="panel">
    <label>ä¸­æ–‡</label>
    <textarea id="inputZh" placeholder="è¼¸å…¥ä¸­æ–‡"></textarea>
    <div class="row" style="margin-top:8px; display:flex; gap:10px;">
      <button id="btnZhEn" class="btn primary">ä¸­æ–‡ âœ è‹±æ–‡</button>
      <button id="btnClearZh" class="btn">æ¸…ç©º</button>
    </div>
  </div>

  <div class="panel">
    <label>English</label>
    <textarea id="outputEn" placeholder="ç¿»è­¯çµæœ / è¦æª¢æŸ¥çš„è‹±æ–‡"></textarea>
    <div class="row" style="margin-top:8px; display:flex; gap:10px;">
      <button id="btnEnZh" class="btn primary">è‹±æ–‡ âœ ä¸­æ–‡</button>
      <button id="btnCheck" class="btn">Grammar</button>
      <button id="btnClearEn" class="btn">æ¸…ç©º</button>
    </div>
  </div>
</div>

<div id="status">âœ¨ ç›´æ¥è¼¸å…¥ä¸­æ–‡æˆ–è‹±æ–‡å³å¯ã€‚</div>

<div id="review">
  <div class="card">
    <strong>ğŸ›  ä¿®æ­£ç´°ç¯€</strong>
    <p class="small">ä¸Šæ–¹é¡¯ç¤ºã€ŒåŸå¥ï¼ˆç´…è‰²åˆªé™¤ï¼‰ã€èˆ‡ã€Œä¿®æ­£æ–‡ï¼ˆç¶ è‰²æ–°å¢ï¼‰ã€ã€‚</p>
    <div><strong>åŸå¥ï¼š</strong> <span id="origHL"></span></div>
    <div><strong>ä¿®æ­£æ–‡ï¼š</strong> <span id="corrHL"></span></div>

    <hr style="border:none;border-top:1px dashed #e6c55b;margin:12px 0;">
    <div>
      <strong>ğŸ“ å»ºè­°æ¸…å–®</strong>
      <ol id="suggestList" class="suggest"></ol>
    </div>
  </div>
</div>

<script>
  /* ================== Grammar engine (LT + Local rules) ================== */
/* è‹¥ä½ æª”æ¡ˆå·²ç¶“æœ‰ IRR / toPast / toPartï¼Œä¿ç•™ä½ åŸæœ¬çš„å³å¯ï¼›å¦å‰‡é€™è£¡æä¾›ä¸€ä»½ */
const IRR = {
  "am":["was","been"], "is":["was","been"], "are":["were","been"],
  "do":["did","done"], "does":["did","done"], "go":["went","gone"],
  "come":["came","come"], "eat":["ate","eaten"], "see":["saw","seen"],
  "take":["took","taken"], "make":["made","made"], "have":["had","had"], "has":["had","had"],
  "get":["got","gotten"], "give":["gave","given"], "write":["wrote","written"],
  "read":["read","read"], "run":["ran","run"], "sleep":["slept","slept"],
  "feel":["felt","felt"], "leave":["left","left"], "meet":["met","met"],
  "pay":["paid","paid"], "put":["put","put"], "say":["said","said"],
  "buy":["bought","bought"], "bring":["brought","brought"], "think":["thought","thought"],
  "teach":["taught","taught"], "begin":["began","begun"], "become":["became","become"],
  "find":["found","found"], "hold":["held","held"], "keep":["kept","kept"],
  "speak":["spoke","spoken"], "drink":["drank","drunk"], "drive":["drove","driven"],
  "forget":["forgot","forgotten"], "forgive":["forgave","forgiven"], "grow":["grew","grown"],
  "know":["knew","known"], "lose":["lost","lost"], "send":["sent","sent"],
  "sit":["sat","sat"], "stand":["stood","stood"], "understand":["understood","understood"],
  "win":["won","won"], "cut":["cut","cut"], "hit":["hit","hit"], "hurt":["hurt","hurt"], "let":["let","let"], "set":["set","set"], "cost":["cost","cost"]
};
function toPast(v){
  const x=v.toLowerCase(); if(IRR[x]) return IRR[x][0];
  if(/[^aeiou]y$/.test(x)) return x.slice(0,-1)+"ied";
  if(x.endsWith("e")) return x+"d";
  return x+"ed";
}
function toPart(v){
  const x=v.toLowerCase(); if(IRR[x]) return IRR[x][1]||IRR[x][0];
  if(/[^aeiou]y$/.test(x)) return x.slice(0,-1)+"ied";
  if(x.endsWith("e")) return x+"d";
  return x+"ed";
}

/* å°å­—å…¸ï¼ˆå¸¸è¦‹æ‹¼å­—ï¼‰ */
const SPELL = {
  "becuase":"because","recieve":"receive","seperate":"separate","definately":"definitely",
  "wierd":"weird","adress":"address","enviroment":"environment","tomatos":"tomatoes",
  "alot":"a lot","occured":"occurred","wich":"which","thier":"their","beleive":"believe",
  "freind":"friend","studing":"studying","untill":"until","sory":"sorry","conisder":"consider",
  "consder":"consider","considre":"consider","improvment":"improvement"
};

/* â€”â€”â€”â€”â€” Local rules pass â€”â€”â€”â€”â€” */
function localFixOnce(src){
  let s=src, count=0; const changes=[];
  const add=(title,from,to,msg="")=>{ if(from!==to){ count++; changes.push({title,from,to,msg}); } };
  const capSentences = () => {
    s = s.replace(/(^|\.\s+|\?\s+|!\s+)([a-z])/g,(m,pre,ch)=>{
      const rep=pre+ch.toUpperCase(); if(rep!==m) add("Capitalization",m,rep,"Capitalize the start of a sentence."); return rep;
    });
  };

  // 0) æ‹¼å­—ï¼ˆå¿«é€Ÿä¿®æ­£ï¼‰
  s = s.replace(/\b([A-Za-z']+)\b/g,(m,w)=>{
    const low=w.toLowerCase(); const fix=SPELL[low]; if(fix){
      const rep = (w===w.toUpperCase())?fix.toUpperCase(): (w[0]===w[0].toUpperCase()?fix[0].toUpperCase()+fix.slice(1):fix);
      if(rep!==w) add("Spelling",w,rep,"Common misspelling."); return rep;
    }
    return w;
  });

  // 1) a/an
  s = s.replace(/\b(a)\s+([aeiouAEIOU])/g,(m,a,v)=>{const rep='an '+v; add("Article (a/an)",m,rep,"Use â€˜anâ€™ before a vowel sound."); return rep;});
  s = s.replace(/\b(an)\s+([^aeiouAEIOU\s])/g,(m,an,v)=>{const rep='a '+v; add("Article (a/an)",m,rep,"Use â€˜aâ€™ before a consonant sound."); return rep;});

  // 2) be å‹•è©ä¸€è‡´
  s = s.replace(/\bI\s+are\b/gi, ()=>{add("Be-verb", "I are", "I am", "â€˜Iâ€™ takes â€˜amâ€™."); return "I am";});
  s = s.replace(/\bI\s+is\b/gi,  ()=>{add("Be-verb", "I is", "I am", "â€˜Iâ€™ takes â€˜amâ€™."); return "I am";});
  s = s.replace(/\b(you|we|they)\s+is\b/gi,(m,p)=>{const rep=p+" are"; add("Be-verb",m,rep,"Plural subjects take â€˜areâ€™."); return rep;});
  s = s.replace(/\b(he|she|it)\s+are\b/gi,(m,p)=>{const rep=p+" is"; add("Be-verb",m,rep,"he/she/it â†’ is"); return rep;});

  // 3) have/has ä¸€è‡´
  s = s.replace(/\bI\s+has\b/gi, ()=>{add("Have/has","I has","I have","â€˜Iâ€™ takes â€˜haveâ€™."); return "I have";});
  s = s.replace(/\b(you|we|they)\s+has\b/gi,(m,p)=>{const rep=p+" have"; add("Have/has",m,rep,"Plural subjects take â€˜haveâ€™."); return rep;});
  s = s.replace(/\b(he|she|it)\s+have\b/gi,(m,p)=>{const rep=p+" has"; add("Have/has",m,rep,"he/she/it â†’ has"); return rep;});

  // 4) å–®æ•¸ä¸»èª + è¤‡æ•¸è¡¨èª â†’ å–®æ•¸åè©ï¼ˆI/he/she/it am|is boys â†’ a boyï¼‰
  const SING = {"boys":"boy","girls":"girl","students":"student","teachers":"teacher","friends":"friend",
                "cats":"cat","dogs":"dog","books":"book","apples":"apple","men":"man","women":"woman",
                "children":"child","people":"person"};
  s = s.replace(/\b(I|he|she|it)\s+(am|is)\s+([A-Za-z]+)\b/g,(m,subj,be,n)=>{
    const low=n.toLowerCase(); if(!SING[low]) return m;
    const word=SING[low]; const art=/^[aeiou]/i.test(word)?"an":"a";
    const rep=`${subj} ${be} ${art} ${word}`;
    add("Predicate number",m,rep,"Singular subject needs a singular complement."); return rep;
  });

  // 5) he/she/it å‹•è©ä¸‰å–® -s
  s = s.replace(/\b(he|she|it)\s+(go|do|have|say|play|watch|clean|study|try|fly|cry|walk|work|eat|come)\b/gi,(m,subj,verb)=>{
    const v=verb.toLowerCase(); let v3=v;
    if(v==='have') v3='has'; else if(v==='do') v3='does'; else if(v==='go') v3='goes';
    else if(/[^aeiou]y$/.test(v)) v3=v.slice(0,-1)+"ies";
    else if(/(sh|ch|x|s|o)$/.test(v)) v3=v+"es"; else v3=v+"s";
    const rep=`${subj} ${v3}`; if(rep!==m){ add("Agreement (3rd)",m,rep,"Add -s/-es in 3rd person."); } return rep;
  });
/* 5.24) go to shopping â†’ go shoppingï¼ˆæ‰€æœ‰æ™‚æ…‹ï¼‰ */
s = s.replace(/\b(go|goes|went|gone|going)\s+to\s+shopping\b/gi, (m, v) => `${v} shopping`);

/* 5.24b) è‹±å¼ mum â†’ ç¾å¼ momï¼›with mum â†’ with my mom */
s = s.replace(/\bwith\s+(?:my\s+)?mum\b/gi, 'with my mom');
s = s.replace(/\bmum\b/gi, 'mom');

/* 5.24c) å¥é¦–æœªä¾†æ™‚é–“ + ã€Œgo (to) shopping + ä¸»èªã€â†’ é‡æ’èªåºä¸¦è£œ will
   ä¾‹ï¼šTomorrow morning go to shopping I with mom â†’ Tomorrow morning I will go shopping with my mom.
   èªªæ˜ï¼š
   - åªåœ¨åµæ¸¬åˆ°æœªä¾†æ™‚é–“æ¨™è¨˜æ™‚å•Ÿå‹•ï¼ˆæœªä¾†å¼é‚è¼¯ç›¸å®¹ï¼‰
   - æ•æ‰ã€Œgo (to) shopping + ä¸»èªã€ä¸¦æŠŠä¸»èªæ›åˆ°å‹•è©å‰ï¼Œå†è£œ will
*/
(function () {
  const FUTURE_AHEAD = /\b(tomorrow|next\s+\w+|soon|in\s+\d+\s+(minutes?|hours?|days?|weeks?|months?|years?)|later|this\s+(afternoon|evening|weekend|week))\b/i;

  if (FUTURE_AHEAD.test(s)) {
    // go (to) shopping + I/you/he/she/we/they (+ å…¶å¾Œç‰‡èª)
    s = s.replace(
      /\bgo(?:\s+to)?\s+shopping\s+(I|you|he|she|we|they)\b([^.!?]*)/gi,
      (m, subj, tail) => `${subj} will go shopping${tail}`
    );
    // å¦‚æœæ˜¯ goes ä¹Ÿä¸€ä½µè™•ç†ï¼ˆä¸»èªæœƒè¢«æ›åˆ°å‰é¢ï¼Œå‹•è©æ”¹å› base ä»¥æ­é… willï¼‰
    s = s.replace(
      /\bgoes\s+(?:to\s+)?shopping\s+(he|she|it)\b([^.!?]*)/gi,
      (m, subj, tail) => `${subj} will go shopping${tail}`
    );
  }
})();
  // 6) ä¸å®šè© / æƒ…æ…‹ï¼šå‹•è©åŸå½¢ï¼ˆto slept â†’ to sleepï¼›can ate â†’ can eatï¼‰
  (function(){
    const IRR_BASE={}; Object.keys(IRR).forEach(b=>{ const [v2,v3]=IRR[b]; IRR_BASE[v2]=b; IRR_BASE[(v3||v2)]=b; });
    const toBase = w=>{
      const lw=w.toLowerCase(); if(IRR_BASE[lw]) return IRR_BASE[lw];
      if(/[^aeiou]ied$/i.test(w)) return w.replace(/ied$/i,'y');
      if(/([bcdfghjklmnpqrstvwxyz])ed$/i.test(w)) return w.replace(/ed$/i,'');
      if(/([sxz]|sh|ch)es$/i.test(w)) return w.replace(/es$/i,'');
      if(/ies$/i.test(w)) return w.replace(/ies$/i,'y');
      if(/s$/i.test(w)) return w.replace(/s$/i,'');
      return w;
    };
    s = s.replace(/\bto\s+([a-z]+)\b/gi,(m,v)=>{ const base=toBase(v); const rep=`to ${base}`; if(rep!==m){ add("Infinitive base",m,rep,"Use base form after â€˜toâ€™."); } return rep; });
    s = s.replace(/\b(can|could|will|would|shall|should|may|might|must|let|did|does|do)\s+([a-z]+)\b/gi,(m,aux,v)=>{ const base=toBase(v); const rep=`${aux} ${base}`; if(rep!==m){ add("Modal base",m,rep,"Use base form after a modal/aux."); } return rep; });
  })();

  // 7) Present Perfectï¼šè¦ç¯„ have/has + V3ï¼ˆç¾å¼ getâ†’gottenï¼‰ï¼Œé˜²å‘† goned/goed
  (function(){
    // å…ˆçŸ¯æ­£æ˜é¡¯éŒ¯åˆ†è©
    const MIST = {"goed":"gone","goned":"gone","goted":"gotten","buyed":"bought","taked":"taken","eated":"eaten","comed":"come","runned":"run",
                  "thinked":"thought","bringed":"brought","sleeped":"slept","choosed":"chosen","writed":"written","sended":"sent","drived":"driven",
                  "forgived":"forgiven","forgeted":"forgotten"};
    s = s.replace(/\b(have|has)\s+([a-z]+)\b/gi,(m,aux,w)=>{
      const low=w.toLowerCase();
      if(MIST[low]){ const rep=`${aux} ${MIST[low]}`; add("Present perfect fix",m,rep,"Use correct past participle (V3)."); return rep; }
      // V2 â†’ V3ï¼ˆhave went â†’ have goneï¼‰
      const baseByV2 = Object.fromEntries(Object.entries(IRR).map(([b,[v2]])=>[v2,b]));
      if(baseByV2[low]){ const b=baseByV2[low]; const v3=toPart(b); const rep=`${aux} ${v3}`; if(rep!==m){ add("Present perfect V2â†’V3",m,rep,"Use V3 after â€˜have/hasâ€™."); } return rep; }
      // è‹¥æ˜¯åŸå½¢ï¼ˆhave goï¼‰â†’ have gone
      const bases=new Set(Object.keys(IRR));
      if(bases.has(low)){ const rep=`${aux} ${toPart(low)}`; if(rep!==m){ add("Present perfect baseâ†’V3",m,rep,"Use V3 after â€˜have/hasâ€™."); } return rep; }
      return m;
    });
  })();

  // 8) Past tenseï¼šåµæ¸¬éå»æ™‚é–“æ¨™è¨˜ â†’ å‹•è©ç”¨éå»å¼
  const pastMark=/\b(yesterday|last\s+(night|week|month|year|mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)|\d+\s+(minute|hour|day|week|month|year)s?\s+ago|ago)\b/i;
  if(pastMark.test(s)){
    s = s.replace(/\b(I|you|we|they|he|she|it)\s+([a-z]+)\b/gi,(m,subj,verb)=>{
      const v=verb.toLowerCase();
      if(/^(am|is|are|was|were|been|be|have|has|had|do|does|did|will|can|should|would|might|must)$/.test(v)) return m;
      if(/(ed|t)$/.test(v) || Object.values(IRR).some(a=>a[0]===v)) return m;
      const rep=`${subj} ${toPast(v)}`; add("Past tense",m,rep,"Use past tense with past-time markers."); return rep;
    });
  }

  // 9) Futureï¼šåµæ¸¬æœªä¾†æ™‚é–“æ¨™è¨˜ â†’ æ²’æœ‰ will/going to å°±è£œ will
  const futureMark=/\b(tomorrow|next\s+(week|month|year|mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)|soon|in\s+\d+\s+(minutes?|hours?|days?|weeks?|months?|years?))\b/i;
  if(futureMark.test(s) && !/\b(will|going to|be going to|plan to|intend to)\b/i.test(s)){
    s = s.replace(/\b(I|you|we|they|he|she|it)\s+([a-z]+)\b/gi,(m,subj,verb)=>{
      const v=verb.toLowerCase(); if(/^(am|is|are|was|were|been|be|have|has|had|do|does|did|can|should|would|might|must|will)$/.test(v)) return m;
      const rep = `${subj} will ${v}`; add("Future",m,rep,"Add â€˜willâ€™ for clear future time."); return rep;
    });
  }

  // 10) å¸¸è¦‹ä»‹ç³»è©ä¿®æ­£
  [
    [/\bmarried with\b/gi,"married to","Use â€˜toâ€™ with â€˜marriedâ€™. "],
    [/\bdepend of\b/gi,"depend on","Use â€˜onâ€™ after â€˜dependâ€™. "],
    [/\binterested on\b/gi,"interested in","Use â€˜inâ€™ after â€˜interestedâ€™. "],
    [/\bdifferent than\b/gi,"different from","Prefer â€˜different fromâ€™. "],
    [/\barrive to\b/gi,"arrive at","Use â€˜atâ€™ with â€˜arriveâ€™. "],
    [/\barrive to home\b/gi,"arrive home","Drop the preposition with â€˜homeâ€™. "],
    [/\bdiscuss about\b/gi,"discuss","â€˜Discussâ€™ doesnâ€™t take â€˜aboutâ€™. "],
    [/\blisten (?!to)\b/gi,"listen to","Use â€˜toâ€™ after â€˜listenâ€™. "],
    [/\b(go|went|gone)\s+(school|work|class|church|library|park|store|market|hospital|office|airport|station|zoo|museum|cinema|theater|beach|farm)\b/gi,null,"Use â€˜toâ€™ with â€˜goâ€™ + place (except â€˜homeâ€™)."]
  ].forEach(([re,to,why])=>{
    if(to){
      s = s.replace(re,(m)=>{ const rep=to; add("Preposition",m,rep,why); return rep; });
    }else{
      // go + place â†’ go to place
      s = s.replace(re,(m,go,place)=>{ const rep=`${go} to ${place}`; add("Preposition",m,rep,why); return rep; });
    }
  });

  // 11) å¥é¦–å¤§å¯« & ç©ºç™½æ¸…ç†
  capSentences();
  const before=s; s=s.replace(/ {2,}/g,' ').replace(/\s+([,.!?;:])/g,'$1');
  if(before!==s) add("Punctuation spacing","extra space","cleaned","Remove extra spaces.");
  return { text:s, count, changes };
}
/* 12) å–®æ•¸ä¸»èª + è¤‡æ•¸è¡¨èª â†’ å–®æ•¸åè©ï¼ˆæ›´å¥å£¯ç‰ˆï¼‰ */
(function () {
  // å–®æ•¸åŒ–ï¼šå…ˆè™•ç†å°‘é‡ä¸è¦å‰‡ï¼Œå…¶æ¬¡å†è™•ç†è¦å‰‡è®ŠåŒ–
  const IRR_PL2SG = {
    men: "man", women: "woman", children: "child", people: "person",
    teeth: "tooth", feet: "foot", mice: "mouse", geese: "goose"
  };

  function singularize(word) {
    const low = word.toLowerCase();
    if (IRR_PL2SG[low]) return matchCase(IRR_PL2SG[low], word);
    if (/ies$/i.test(word)) return word.replace(/ies$/i, "y");            // babies â†’ baby
    if (/(ses|xes|zes|ches|shes)$/i.test(word)) return word.replace(/es$/i, ""); // classes â†’ class / boxes â†’ box
    if (/s$/i.test(word) && !/ss$/i.test(word)) return word.replace(/s$/i, ""); // boys â†’ boyï¼›ä½†ä¿ç•™ glass / boss
    return word; // æœ¬ä¾†å°±å–®æ•¸å°±ä¸å‹•
  }
  function articleFor(w){ return /^[aeiou]/i.test(w) ? "an" : "a"; }

  // I/he/she/it + am/is + (å¯é¸å¤šè©ä¿®é£¾) + è¤‡æ•¸åè©
  s = s.replace(
    /\b(I|he|she|it)\s+(am|is)\s+((?:[a-z]+(?:\s+|$))*)?([a-z]+s)\b/gi,
    (m, subj, be, mods = "", plural) => {
      const modsTrim = (mods || "").trim();          // ä¾‹å¦‚ "very tall "
      const sing = singularize(plural);              // boys â†’ boy / babies â†’ babyâ€¦
      const needArticle = modsTrim ? "" : (articleFor(sing) + " "); // æœ‰å½¢å®¹è©æ™‚å¸¸å·²å«å† è©ï¼Œä¸å¼·å¡
      const rep = `${subj} ${be} ${needArticle}${modsTrim ? modsTrim + " " : ""}${sing}`;
      add("Predicate number", m, rep, "Singular subject â†’ singular complement.");
      return rep;
    }
  );
})();
  /* 11.9) ä¿®æ­£å¸¸è¦‹çš„ã€ŒTomorrow to school, I and Gigiã€çµæ§‹ */
s = s.replace(
  /\bTomorrow(?: morning| afternoon| evening)?\s+to\s+(school|work|class|church|library|park|store|market|hospital|office)\s*,?\s*i\s+and\s+([A-Z][a-z]+)\b/gi,
  (m, place, name) => {
    const rep = `I will go to ${place} with ${name} tomorrow`;
    add("Future sentence fix", m, rep, "Normalize future tense: subject + will go to + place + with + companion + tomorrow.");
    return rep;
  }
);
/* â€”â€”â€”â€”â€” LanguageTool pass + local pass â€”â€”â€”â€”â€” */
async function grammarPipeline(inputText){
  let text = inputText, ltChanges = [];
  // 1) LanguageToolï¼ˆå…¬å…±é›²ï¼‰
  try{
    const p = new URLSearchParams();
    p.append("text", text);
    p.append("language","en-US");
    p.append("enabledCategories","GRAMMAR,CONFUSED_WORDS,TYPOGRAPHY,PUNCTUATION,REDUNDANCY,STYLE");
    const r = await fetch("https://api.languagetool.org/v2/check",{
      method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body:p
    });
    if(r.ok){
      const j = await r.json();
      const matches=(j.matches||[]).filter(m=>m.replacements&&m.replacements[0]).sort((a,b)=>b.offset-a.offset);
      for(const m of matches){
        const from=text.slice(m.offset, m.offset+m.length);
        const to=m.replacements[0].value;
        text=text.slice(0,m.offset)+to+text.slice(m.offset+m.length);
        ltChanges.push({title:"LanguageTool",from,to,msg:m.message||""});
      }
    }
  }catch(_e){ /* è‹¥ LT æš«æ™‚é€£ä¸åˆ°ï¼Œå°±åªè·‘æœ¬åœ°è¦å‰‡ */ }

  // 2) Local rulesï¼ˆè£œ LT æŠ“ä¸åˆ°çš„ï¼špresent perfect/éå»&æœªä¾†/ä»‹ç³»è©/ä¸€è‡´æ€§ç­‰ï¼‰
  const local = localFixOnce(text);

  return {
    text: local.text,
    total: ltChanges.length + local.count,
    ltCount: ltChanges.length,
    localCount: local.count,
    changes: [...ltChanges, ...local.changes]
  };
                                                                                                          }
/* ====== å…±ç”¨ UI å·¥å…· ====== */
const ui = {
  inputZh: document.getElementById('inputZh'),
  outputEn: document.getElementById('outputEn'),
  zh2en: document.getElementById('btnZhEn'),
  en2zh: document.getElementById('btnEnZh'),
  check: document.getElementById('btnCheck'),
  clearZh: document.getElementById('btnClearZh'),
  clearEn: document.getElementById('btnClearEn'),
  status: document.getElementById('status'),
  origHL: document.getElementById('origHL'),
  corrHL: document.getElementById('corrHL'),
  review: document.getElementById('review'),
  suggestList: document.getElementById('suggestList')
};
function setStatus(msg){ ui.status.textContent = msg; }
const esc = t => t.replace(/[&<>"']/g, c => ({'&':"&amp;",'<':"&lt;",'>':"&gt;",'"':"&quot;","'":"&#39;"}[c]));
function diffHL(oldText, newText){
  if(oldText === newText) return {origHL:esc(oldText), corrHL:esc(newText)};
  let s=0, eOld=oldText.length-1, eNew=newText.length-1;
  while(s<=eOld && s<=eNew && oldText[s]===newText[s]) s++;
  while(eOld>=s && eNew>=s && oldText[eOld]===newText[eNew]){ eOld--; eNew--; }
  return {
    origHL: esc(oldText.slice(0,s))+'<span class="hl-del">'+esc(oldText.slice(s,eOld+1))+'</span>'+esc(oldText.slice(eOld+1)),
    corrHL: esc(newText.slice(0,s))+'<span class="hl-ins">'+esc(newText.slice(s,eNew+1))+'</span>'+esc(newText.slice(eNew+1))
  };
}
function renderSuggestions(changes){
  ui.suggestList.innerHTML="";
  changes.forEach(ch=>{
    const li=document.createElement('li');
    li.innerHTML = `<strong>${esc(ch.title)}</strong>ï¼š ${esc(ch.msg||"")}<br>
      <span class="chip-old">${esc(ch.from)}</span> â†’ <span class="chip-new">${esc(ch.to)}</span>`;
    ui.suggestList.appendChild(li);
  });
}

/* ====== ç¿»è­¯ï¼šMyMemory + LibreTranslate å‚™æ´ ====== */
const LT_NODES = [
  "https://libretranslate.de",
  "https://translate.argosopentech.com",
  "https://translate.mentality.rip"
];
async function fetchWithTimeout(url, options={}, timeoutMs=9000){
  const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
  try{ const r=await fetch(url, {...options, signal:ctrl.signal}); clearTimeout(t); return r; }
  catch(e){ clearTimeout(t); throw e; }
}
async function translateViaMyMemory(text, dir){
  const source=(dir==="zh-en")?"zh-CN":"en";
  const target=(dir==="zh-en")?"en":"zh-TW";
  const r=await fetchWithTimeout(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${source}|${target}`);
  if(!r.ok) throw new Error("MyMemory "+r.status);
  const j=await r.json();
  return j?.responseData?.translatedText || "";
}
async function translateViaLibre(base, text, dir){
  const target=(dir==="zh-en")?"en":"zh-TW";
  const r=await fetchWithTimeout(`${base}/translate`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ q:text, source:"auto", target, format:"text" })
  });
  if(!r.ok) throw new Error("Libre "+r.status);
  const j=await r.json(); return j?.translatedText || "";
}
async function translateSmart(text, dir){
  if(!text || !text.trim()) return "";
  try{
    const mm=await translateViaMyMemory(text, dir);
    if(mm && mm.trim()) return mm;
  }catch(_e){}
  for(const n of LT_NODES){
    try{
      const x=await translateViaLibre(n, text, dir);
      if(x && x.trim()) return x;
    }catch(_e){}
  }
  // è‹¥å…¨éƒ¨å¤±æ•—ï¼ŒåŸæ–‡å›å¡«
  setStatus("âš ï¸ ç¿»è­¯æœå‹™æš«æ™‚ç„¡æ³•é€£ç·šï¼Œå·²é¡¯ç¤ºåŸæ–‡ã€‚");
  return text;
}

/* ====== LanguageToolï¼šæ™ºæ…§ä¿®æ­£ ====== */
async function grammarPipeline(text){
  try{
    const p=new URLSearchParams();
    p.append("text", text);
    p.append("language","en-US");
    const r=await fetch("https://api.languagetool.org/v2/check",{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:p
    });
    if(!r.ok) throw new Error("HTTP "+r.status);
    const j=await r.json();
    const ms=(j.matches||[]).filter(m=>m.replacements&&m.replacements[0]).sort((a,b)=>b.offset-a.offset);
    let out=text, changes=[];
    for(const m of ms){
      const from=out.slice(m.offset, m.offset+m.length);
      const to=m.replacements[0].value;
      out=out.slice(0,m.offset)+to+out.slice(m.offset+m.length);
      changes.push({ title:"LanguageTool", from, to, msg:m.message||"" });
    }
    return { text:out, count:changes.length, changes };
  }catch(e){
    setStatus("âŒ Grammar check å¤±æ•—ï¼š" + e.message);
    return { text, count:0, changes:[] };
  }
}

/* ====== äº‹ä»¶ç¶å®š ====== */
ui.zh2en.addEventListener('click', async()=>{
  const txt=ui.inputZh.value.trim(); if(!txt){ return; }
  setStatus("ç¿»è­¯ä¸­ï¼ˆä¸­ âœ è‹±ï¼‰â€¦");
  ui.outputEn.value = await translateSmart(txt,"zh-en");
  setStatus("âœ… å®Œæˆï¼šä¸­æ–‡ âœ è‹±æ–‡");
});

ui.en2zh.addEventListener('click', async()=>{
  const txt=ui.outputEn.value.trim(); if(!txt){ return; }
  setStatus("ç¿»è­¯ä¸­ï¼ˆè‹± âœ ä¸­ï¼‰â€¦");
  ui.outputEn.value = await translateSmart(txt,"en-zh");
  setStatus("âœ… å®Œæˆï¼šè‹±æ–‡ âœ ä¸­æ–‡(ç¹é«”)");
});

ui.check.addEventListener('click', async()=>{
  const before = ui.outputEn.value.trim(); if(!before){ return; }
  setStatus("Grammar æª¢æŸ¥ä¸­â€¦");
  const res = await grammarPipeline(before);
  ui.outputEn.value = res.text;

  const d = diffHL(before, res.text);
  if(res.text !== before){
    ui.origHL.innerHTML = d.origHL;
    ui.corrHL.innerHTML = d.corrHL;
    ui.review.style.display = "block";
  }else{
    ui.review.style.display = "none";
  }
  renderSuggestions(res.changes);
  setStatus(`âœ… å·²å®Œæˆæ™ºæ…§ä¿®æ­£ï¼ˆä¿®æ­£ ${res.count} è™•ï¼‰`);
});

ui.clearZh.addEventListener('click',()=>ui.inputZh.value="");
ui.clearEn.addEventListener('click',()=>ui.outputEn.value="");
</script>
</body>
</html>
