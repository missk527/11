<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title> Miss K English class</title>
<style>
:root{
  --kids-bg:#FFF7CC; --kids-panel:#FFE680; --kids-panel-2:#FFEF99;
  --kids-accent:#FFB703; --kids-accent-2:#FB8500; --kids-text:#3A2D00;
  --kids-muted:#6B5600; --kids-border:#FFD259; --kids-shadow:0 6px 18px rgba(160,120,0,.18);
  --kids-radius:12px;
}
body{ background:var(--kids-bg)!important; color:var(--kids-text)!important;
  font-family:"Comic Sans MS","Noto Sans TC","Microsoft JhengHei",system-ui,Arial,sans-serif!important; line-height:1.6;
  padding-bottom: 90px; /* 預留底部空間，避免貼紙遮擋 */
}
header{ background:linear-gradient(180deg,var(--kids-panel),var(--kids-panel-2))!important;
  border-bottom:2px dashed var(--kids-border)!important; box-shadow:var(--kids-shadow)!important;
  padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
h1{ color:var(--kids-text)!important; font-size:18px; margin:0; } h1::before{ content:"🦁"; margin-right:6px; }
.btn{ padding:10px 14px!important; border:2px solid var(--kids-border)!important; border-radius:20px!important;
  background:#fff8d9!important; color:var(--kids-text)!important; box-shadow:var(--kids-shadow)!important; font-weight:700!important; }
.btn.primary{ background:var(--kids-accent)!important; border-color:var(--kids-accent-2)!important; color:#1b1100!important; }
textarea{ width:100%; height:220px; border-radius:14px!important; border:2px solid var(--kids-border)!important;
  background:#fffef5!important; color:var(--kids-text)!important; font-size:15px!important; padding:10px; }
#status{ border:2px dashed var(--kids-border)!important; border-radius:var(--kids-radius)!important;
  background:#fff7d1!important; color:var(--kids-text)!important; box-shadow:var(--kids-shadow)!important; padding:12px; margin:18px; }
.grid{ display:grid; gap:14px; margin:18px; } @media(min-width:800px){ .grid{ grid-template-columns:1fr 1fr; } }
.panel{ background:#fffbea; border:2px solid var(--kids-border); border-radius:var(--kids-radius); padding:14px; box-shadow: var(--kids-shadow); }
label{ display:block; margin-bottom:8px; font-weight:900; color:var(--kids-muted); }
/* 高亮 */
.hl-del{ background:#ffe3e3; text-decoration:line-through; border-radius:4px; padding:0 2px; }
.hl-ins{ background:#ddf8dd; border-bottom:2px solid #2d8a2d; border-radius:4px; padding:0 2px; }
.small{ font-size:13px; color:#5f4b00; }
#review{ display:none; margin:18px; }

/* === 貼紙修正 === */
body::after{
  content:" 🐻🐰🦊 一起學English ！ ";
  position: fixed;
  right: 10px;
  bottom: 6px;           /* 更靠底 */
  background:#fff;
  border:2px solid var(--kids-border);
  border-radius:14px;
  padding:8px 10px;
  box-shadow:var(--kids-shadow);
  font-weight:800;
  color:var(--kids-text);
  transform: scale(.9);  /* 稍微縮小 */
  pointer-events: none;  /* 不攔截點擊/選字 */
}
@media (max-width: 480px){
  body{ padding-bottom: 110px; } /* 手機多留空間 */
  body::after{
    bottom: 2px;
    right: 6px;
    transform: scale(.85);
  }
}
</style>
</head>
<body>
<header>
  <h1>Miss K English class</h1>
  
</header>

<div class="grid">
  <div class="panel">
    <label>中文</label>
    <textarea id="inputZh" placeholder="輸入中文"></textarea>
    <div class="row">
      <button id="btnZhEn" class="btn primary">中文 ➜ 英文</button>
      <button id="btnClearZh" class="btn">清空</button>
    </div>
  </div>

  <div class="panel">
    <label>English</label>
    <textarea id="outputEn" placeholder="翻譯結果"></textarea>
    <div class="row">
      <button id="btnEnZh" class="btn primary">英文 ➜ 中文</button>
      <button id="btnCheck" class="btn">Grammar</button>
      <button id="btnClearEn" class="btn">清空</button>
    </div>
  </div>
</div>

<div id="status">✨ 直接輸入中文或英文即可。</div>

<div id="review" class="panel">
  <strong>🛠 修正細節</strong>
  <p class="small">紅色刪除，綠色新增。</p>
  <div><strong>原句：</strong> <span id="origHL"></span></div>
  <div><strong>修正文：</strong> <span id="corrHL"></span></div>
</div>

<script>
(function(){
  const ui = {
    inputZh: document.getElementById('inputZh'),
    outputEn: document.getElementById('outputEn'),
    zh2en: document.getElementById('btnZhEn'),
    en2zh: document.getElementById('btnEnZh'),
    check: document.getElementById('btnCheck'),
    clearZh: document.getElementById('btnClearZh'),
    clearEn: document.getElementById('btnClearEn'),
    status: document.getElementById('status'),
    save: document.getElementById('btnSave'),
    diag: document.getElementById('btnDiag'),
    origHL: document.getElementById('origHL'),
    corrHL: document.getElementById('corrHL'),
    review: document.getElementById('review')
  };
  function setStatus(msg){ ui.status.textContent = msg; }
  function escapeHTML(s){ return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  async function libreTranslate(text, target){
    const res = await fetch("https://libretranslate.de/translate", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ q:text, source:"auto", target:target, format:"text" })
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();
    return data.translatedText;
  }
  async function myMemory(text, source, target){
    const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${source}|${target}`;
    const r=await fetch(url); const j=await r.json();
    return j?.responseData?.translatedText || "";
  }
  async function translateSmart(text, dir){
    try{
      return await libreTranslate(text, dir==="zh-en"?"en":"zh-TW");
    }catch(e){
      setStatus("⚠️ 重新檢查。");
      return await myMemory(text, dir==="zh-en"?"zh-CN":"en", dir==="zh-en"?"en":"zh-TW");
    }
  }

  // ===== Grammar 多輪檢查 =====
  const MAX_PASSES = 3;

  async function applyLanguageToolOnce(input){
    try{
      const p=new URLSearchParams();
      p.append("text", input);
      p.append("language","en-US");
      p.append("enabledCategories","GRAMMAR,CONFUSED_WORDS,TYPOGRAPHY,PUNCTUATION");
      const r=await fetch("https://api.languagetool.org/v2/check", {
        method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body:p
      });
      if(!r.ok) throw new Error("HTTP "+r.status);
      const j=await r.json();
      const ms = (j.matches||[]).filter(m=>m.replacements&&m.replacements[0])
                                .sort((a,b)=>b.offset-a.offset);
      let out = input;
      for(const m of ms){
        const rep = m.replacements[0].value;
        out = out.slice(0, m.offset) + rep + out.slice(m.offset + m.length);
      }
      return { text: out, count: ms.length };
    }catch(e){
      return { text: input, count: 0 };
    }
  }

  function localFixOnce(src){
    let s = src, c = 0;
    const rules = [
      {re:/\bhim\s+([A-Za-z]+)/g, fn:(m,p)=>{c++; return "his "+p;}},
      {re:/\bher\s+([A-Za-z]+)/g, fn:(m,p)=>{c++; return "her "+p;}},
      {re:/\bthem\s+([A-Za-z]+)/g, fn:(m,p)=>{c++; return "their "+p;}},
      {re:/\b(a)\s+([aeiouAEIOU])/g, fn:(m,a,v)=>{c++; return "an "+v;}},
      {re:/\b(an)\s+([^aeiouAEIOU\s])/g, fn:(m,an,c1)=>{c++; return "a "+c1;}},
      {re:/\b(you|they)\s+was\b/gi, fn:(m,subj)=>{c++; return subj+" were";}},
      {re:/(^|[.!?]\s+)([a-z])/g, fn:(m,pre,ch)=>{c++; return pre+ch.toUpperCase();}}
    ];
    for(const r of rules){ s = s.replace(r.re, r.fn); }
    return { text: s, count: c };
  }

  function diffHL(oldText, newText){
    if(oldText===newText) return {
      origHL: escapeHTML(oldText),
      corrHL: escapeHTML(newText)
    };
    let s=0, eOld=oldText.length-1, eNew=newText.length-1;
    while(s<=eOld && s<=eNew && oldText[s]===newText[s]) s++;
    while(eOld>=s && eNew>=s && oldText[eOld]===newText[eNew]){ eOld--; eNew--; }
    return {
      origHL: escapeHTML(oldText.slice(0,s))+
              `<span class="hl-del">${escapeHTML(oldText.slice(s,eOld+1))}</span>`+
              escapeHTML(oldText.slice(eOld+1)),
      corrHL: escapeHTML(newText.slice(0,s))+
              `<span class="hl-ins">${escapeHTML(newText.slice(s,eNew+1))}</span>`+
              escapeHTML(newText.slice(eNew+1))
    };
  }

  async function grammarCheck(text){
    if(!text || !text.trim()) return text;

    let cur = text, total = 0, passes = 0;
    for(passes=1; passes<=MAX_PASSES; passes++){
      const before = cur;
      const apiRes = await applyLanguageToolOnce(cur);
      const localRes = localFixOnce(apiRes.text);
      cur = localRes.text;
      total += apiRes.count + localRes.count;
      if(cur === before) break; // 沒變動就停
    }

    const d = diffHL(text, cur);
    if(cur !== text){
      ui.origHL.innerHTML = d.origHL;
      ui.corrHL.innerHTML = d.corrHL;
      ui.review.style.display = "block";
    }else{
      ui.review.style.display = "none";
    }
    setStatus(`✅ 完成：Grammar（共 ${total} 項修正，執行 ${Math.min(passes,MAX_PASSES)} 次）`);
    return cur;
  }

  // === UI 綁定 ===
  ui.zh2en.addEventListener('click', async()=>{
    const txt=ui.inputZh.value.trim(); if(!txt) return;
    setStatus("翻譯中（中→英）…");
    ui.outputEn.value=await translateSmart(txt,"zh-en");
    setStatus("✅ 完成：中文→英文");
  });
  ui.en2zh.addEventListener('click', async()=>{
    const txt=ui.outputEn.value.trim(); if(!txt) return;
    setStatus("翻譯中（英→繁體中文）…");
    ui.outputEn.value=await translateSmart(txt,"en-zh");
    setStatus("✅ 完成：英文→中文(繁體)");
  });
  ui.check.addEventListener('click', async()=>{
    const txt=ui.outputEn.value.trim(); if(!txt) return;
    setStatus("Grammar檢查中…");
    ui.outputEn.value=await grammarCheck(txt);
  });
  ui.clearZh.addEventListener('click',()=>ui.inputZh.value="");
  ui.clearEn.addEventListener('click',()=>ui.outputEn.value="");
  ui.save.addEventListener('click',()=>{
    const blob=new Blob([document.documentElement.outerHTML],{type:"text/html;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="translator-kids-grammar-multipass-fixed.html"; a.click();
    URL.revokeObjectURL(url);
  });
  ui.diag.addEventListener('click', async()=>{
    try{
      const r=await fetch("https://libretranslate.de/");
      setStatus("診斷：LibreTranslate "+(r.ok?"可用":"失敗")+" | HTTP "+r.status);
    }catch(e){ setStatus("診斷：請求失敗"); }
  });
})();
</script>
</body>
</html>
