<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Miss K English class</title>
<style>
:root{
  --kids-bg:#FFF7CC; --kids-panel:#FFE680; --kids-panel-2:#FFEF99;
  --kids-accent:#FFB703; --kids-accent-2:#FB8500; --kids-text:#3A2D00;
  --kids-muted:#6B5600; --kids-border:#FFD259; --kids-shadow:0 6px 18px rgba(160,120,0,.18);
  --kids-radius:12px;
}
body{
  background:var(--kids-bg); color:var(--kids-text);
  font-family:"Comic Sans MS","Noto Sans TC","Microsoft JhengHei",system-ui,Arial,sans-serif;
  line-height:1.6; padding-bottom:110px;
}
header{ background:linear-gradient(180deg,var(--kids-panel),var(--kids-panel-2));
  border-bottom:2px dashed var(--kids-border); box-shadow:var(--kids-shadow);
  padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
h1{ color:var(--kids-text); font-size:18px; margin:0; } h1::before{ content:"ğŸ¦"; margin-right:6px; }
.btn{ padding:10px 14px; border:2px solid var(--kids-border); border-radius:20px;
  background:#fff8d9; color:var(--kids-text); box-shadow:var(--kids-shadow); font-weight:700; }
.btn.primary{ background:var(--kids-accent); border-color:var(--kids-accent-2); color:#1b1100; }
textarea{ width:100%; height:220px; border-radius:14px; border:2px solid var(--kids-border);
  background:#fffef5; color:#3A2D00; font-size:15px; padding:10px; }
#status{ border:2px dashed var(--kids-border); border-radius:var(--kids-radius);
  background:#fff7d1; color:#3A2D00; box-shadow:var(--kids-shadow); padding:12px; margin:18px; }
.grid{ display:grid; gap:14px; margin:18px; } @media (min-width:800px){ .grid{ grid-template-columns:1fr 1fr; } }
.panel{ background:#fffbea; border:2px solid var(--kids-border); border-radius:var(--kids-radius);
  padding:14px; box-shadow:var(--kids-shadow); }
label{ display:block; margin-bottom:8px; font-weight:900; color:#6B5600; }

/* é«˜äº®å·®ç•° */
.hl-del{ background:#ffe3e3; text-decoration:line-through; border-radius:6px; padding:0 4px; }
.hl-ins{ background:#ddf8dd; border-bottom:2px solid #2d8a2d; border-radius:6px; padding:0 4px; }
.small{ font-size:13px; color:#5f4b00; }

/* ä¿®æ­£ç´°ç¯€å¡ç‰‡ */
#review{ display:none; margin:18px; }
#review .card{ background:#fffef5; border:2px solid var(--kids-border); border-radius:var(--kids-radius); padding:14px; box-shadow:var(--kids-shadow); }
.suggest{ margin:8px 0 0 22px; }
.suggest li{ margin:10px 0; }
.chip-old{ background:#ffe3e3; border-radius:6px; padding:0 6px; }
.chip-new{ background:#ddf8dd; border-radius:6px; padding:0 6px; border-bottom:2px solid #2d8a2d; }

/* å³ä¸‹è²¼ç´™ï¼ˆä¸æ“‹é»æ“Šï¼‰ */
body::after{
  content:" ğŸ»ğŸ°ğŸ¦Š ä¸€èµ·å­¸Englishï¼ ";
  position:fixed; right:10px; bottom:8px;
  background:#fff; border:2px solid var(--kids-border); border-radius:14px;
  padding:8px 10px; box-shadow:var(--kids-shadow);
  font-weight:800; color:#3A2D00;
  transform:scale(.9); pointer-events:none;
}
</style>
</head>
<body>
<header>
  <h1>Miss K English class</h1>
</header>

<div class="grid">
  <div class="panel">
    <label>ä¸­æ–‡</label>
    <textarea id="inputZh" placeholder="è¼¸å…¥ä¸­æ–‡"></textarea>
    <div class="row" style="margin-top:8px; display:flex; gap:10px;">
      <button id="btnZhEn" class="btn primary">ä¸­æ–‡ âœ è‹±æ–‡</button>
      <button id="btnClearZh" class="btn">æ¸…ç©º</button>
    </div>
  </div>

  <div class="panel">
    <label>English</label>
    <textarea id="outputEn" placeholder="ç¿»è­¯çµæœ"></textarea>
    <div class="row" style="margin-top:8px; display:flex; gap:10px;">
      <button id="btnEnZh" class="btn primary">è‹±æ–‡ âœ ä¸­æ–‡</button>
      <button id="btnCheck" class="btn">Grammar</button>
      <button id="btnClearEn" class="btn">æ¸…ç©º</button>
    </div>
  </div>
</div>

<div id="status">âœ¨ ç›´æ¥è¼¸å…¥ä¸­æ–‡æˆ–è‹±æ–‡å³å¯ã€‚</div>

<div id="review">
  <div class="card">
    <strong>ğŸ›  ä¿®æ­£ç´°ç¯€</strong>
    <p class="small">ä¸Šæ–¹é¡¯ç¤ºã€ŒåŸå¥ï¼ˆç´…è‰²åˆªé™¤ï¼‰ã€èˆ‡ã€Œä¿®æ­£æ–‡ï¼ˆç¶ è‰²æ–°å¢ï¼‰ã€ã€‚</p>
    <div><strong>åŸå¥ï¼š</strong> <span id="origHL"></span></div>
    <div><strong>ä¿®æ­£æ–‡ï¼š</strong> <span id="corrHL"></span></div>

    <hr style="border:none;border-top:1px dashed #e6c55b;margin:12px 0;">
    <div>
      <strong>ğŸ“ å»ºè­°æ¸…å–®</strong>
      <ol id="suggestList" class="suggest"></ol>
    </div>
  </div>
</div>

<script>
(function(){
  /* ========== åŸºæœ¬ UI ========== */
  const ui = {
    inputZh: document.getElementById('inputZh'),
    outputEn: document.getElementById('outputEn'),
    zh2en: document.getElementById('btnZhEn'),
    en2zh: document.getElementById('btnEnZh'),
    check: document.getElementById('btnCheck'),
    clearZh: document.getElementById('btnClearZh'),
    clearEn: document.getElementById('btnClearEn'),
    status: document.getElementById('status'),
    save: document.getElementById('btnSave'),
    diag: document.getElementById('btnDiag'),
    origHL: document.getElementById('origHL'),
    corrHL: document.getElementById('corrHL'),
    review: document.getElementById('review'),
    suggestList: document.getElementById('suggestList')
  };
  function setStatus(msg){ ui.status.textContent = msg; }
  const esc = t => t.replace(/[&<>"']/g, c => ({'&':"&amp;",'<':"&lt;",'>':"&gt;",'"':"&quot;","'":"&#39;"}[c]));
  function diffHL(oldText, newText){
    if(oldText === newText) return {origHL:esc(oldText), corrHL:esc(newText)};
    let s=0, eOld=oldText.length-1, eNew=newText.length-1;
    while(s<=eOld && s<=eNew && oldText[s]===newText[s]) s++;
    while(eOld>=s && eNew>=s && oldText[eOld]===newText[eNew]){ eOld--; eNew--; }
    return {
      origHL: esc(oldText.slice(0,s))+'<span class="hl-del">'+esc(oldText.slice(s,eOld+1))+'</span>'+esc(oldText.slice(eOld+1)),
      corrHL: esc(newText.slice(0,s))+'<span class="hl-ins">'+esc(newText.slice(s,eNew+1))+'</span>'+esc(newText.slice(eNew+1))
    };
  }
  function renderSuggestions(changes){
    ui.suggestList.innerHTML="";
    changes.forEach(ch=>{
      const li=document.createElement('li');
      li.innerHTML = `<strong>${esc(ch.title)}</strong>ï¼š ${esc(ch.msg||"")}<br>
        <span class="chip-old">${esc(ch.from)}</span> â†’ <span class="chip-new">${esc(ch.to)}</span>`;
      ui.suggestList.appendChild(li);
    });
  }

  /* ========== ç¿»è­¯ï¼šMyMemory â†’ å¤šç¯€é» LibreTranslateï¼ˆå«é€¾æ™‚/è¨ºæ–·ï¼‰ ========== */
  const LT_NODES = [
    "https://libretranslate.de",
    "https://translate.argosopentech.com",
    "https://translate.mentality.rip"
  ];
  async function fetchWithTimeout(url, options={}, timeoutMs=8000){
    const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
    try{ const r=await fetch(url, {...options, signal:ctrl.signal}); clearTimeout(t); return r; }
    catch(e){ clearTimeout(t); throw e; }
  }
  async function translateViaMyMemory(text, dir){
    const source=(dir==="zh-en")?"zh-CN":"en";
    const target=(dir==="zh-en")?"en":"zh-TW";
    const r=await fetchWithTimeout(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${source}|${target}`,{},8000);
    if(!r.ok) throw new Error("MM HTTP "+r.status);
    const j=await r.json(); return j?.responseData?.translatedText || "";
  }
  async function translateViaLibre(base, text, dir){
    const target=(dir==="zh-en")?"en":"zh-TW";
    const r=await fetchWithTimeout(`${base}/translate`,{
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ q:text, source:"auto", target, format:"text" })
    },8000);
    if(!r.ok) throw new Error("LT HTTP "+r.status);
    const j=await r.json(); return j?.translatedText || "";
  }
  async function translateSmart(text, dir){
    if(!text || !text.trim()) return "";
    try{ const mm=await translateViaMyMemory(text, dir); if(mm && mm.trim()) return mm; }catch(_e){}
    for(const n of LT_NODES){ try{ const x=await translateViaLibre(n, text, dir); if(x&&x.trim()) return x; }catch(_e){} }
    setStatus("âš ï¸ ç¿»è­¯æœå‹™æš«æ™‚é€£ä¸ä¸Šï¼ˆå·²é¡¯ç¤ºåŸæ–‡ï¼‰ã€‚"); return text;
  }

  /* ========== Grammar Proï¼šå¤šè¼ªï¼ˆLanguageTool + æœ¬åœ°è¦å‰‡ï¼‰ ========== */
  const IRR = {
    "am":["was","been"], "is":["was","been"], "are":["were","been"],
    "do":["did","done"], "does":["did","done"], "go":["went","gone"],
    "come":["came","come"], "eat":["ate","eaten"], "see":["saw","seen"],
    "take":["took","taken"], "make":["made","made"], "have":["had","had"], "has":["had","had"],
    "get":["got","gotten"], "give":["gave","given"], "write":["wrote","written"],
    "read":["read","read"], "run":["ran","run"], "sleep":["slept","slept"],
    "feel":["felt","felt"], "leave":["left","left"], "meet":["met","met"],
    "pay":["paid","paid"], "put":["put","put"], "say":["said","said"],
    "buy":["bought","bought"], "bring":["brought","brought"], "think":["thought","thought"],
    "teach":["taught","taught"], "begin":["began","begun"], "become":["became","become"],
    "find":["found","found"], "hold":["held","held"], "keep":["kept","kept"],
    "speak":["spoke","spoken"], "drink":["drank","drunk"], "drive":["drove","driven"],
    "forget":["forgot","forgotten"], "forgive":["forgave","forgiven"], "grow":["grew","grown"],
    "know":["knew","known"], "lose":["lost","lost"], "send":["sent","sent"],
    "sit":["sat","sat"], "stand":["stood","stood"], "understand":["understood","understood"],
    "win":["won","won"], "cut":["cut","cut"], "hit":["hit","hit"], "hurt":["hurt","hurt"], "let":["let","let"], "set":["set","set"], "cost":["cost","cost"]
  };
  const SPELL = {
    "becuase":"because","recieve":"receive","seperate":"separate","definately":"definitely",
    "wierd":"weird","adress":"address","enviroment":"environment","tomatos":"tomatoes",
    "alot":"a lot","occured":"occurred","wich":"which","thier":"their","beleive":"believe",
    "freind":"friend","studing":"studying","untill":"until"
  };
  function toPast(v){ if(IRR[v]) return IRR[v][0]; if(/[^aeiou]y$/.test(v)) return v.slice(0,-1)+"ied"; if(v.endsWith("e")) return v+"d"; return v+"ed"; }
  function toPart(v){ if(IRR[v]) return IRR[v][1]||IRR[v][0]; if(/[^aeiou]y$/.test(v)) return v.slice(0,-1)+"ied"; if(v.endsWith("e")) return v+"d"; return v+"ed"; }

  async function applyLanguageToolOnceDetailed(input){
    try{
      const p=new URLSearchParams();
      p.append("text", input);
      p.append("language","en-US");
      p.append("enabledCategories","GRAMMAR,CONFUSED_WORDS,TYPOGRAPHY,PUNCTUATION,REDUNDANCY,STYLE");
      p.append("preferredVariants","en-US");
      const r=await fetch("https://api.languagetool.org/v2/check",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:p});
      if(!r.ok) throw new Error("HTTP "+r.status);
      const j=await r.json();
      const ms=(j.matches||[]).filter(m=>m.replacements&&m.replacements[0]).sort((a,b)=>b.offset-a.offset);
      let out=input, changes=[];
      for(const m of ms){
        const from=out.slice(m.offset, m.offset+m.length);
        const to=m.replacements[0].value;
        out=out.slice(0,m.offset)+to+out.slice(m.offset+m.length);
        changes.push({ title:"LanguageTool", from, to, msg:m.message||"" });
      }
      return { text:out, count:changes.length, changes };
    }catch(e){ return { text:input, count:0, changes:[] }; }
  }

  function localFixOnce(src){
    let s=src, count=0; const changes=[];
    const add=(title,from,to,msg="")=>{ if(from!==to){ count++; changes.push({title,from,to,msg}); } };
    const matchCase=(t,s)=>{ if(s===s.toUpperCase())return t.toUpperCase(); if(s[0]===s[0].toUpperCase())return t[0].toUpperCase()+t.slice(1); return t; };

    /* 0) å¥é¦–å¤§å¯« */
    s = s.replace(/(^|\.\s+|\?\s+|!\s+)([a-z])/g,(m,pre,ch)=>{ add("Capitalization", ch, ch.toUpperCase(), "Sentence should start with an uppercase letter."); return pre+ch.toUpperCase(); });

    /* 1) æ‹¼å­— */
    s = s.replace(/\b([A-Za-z']+)\b/g,(m,w)=>{const low=w.toLowerCase();if(SPELL[low]){const to=matchCase(SPELL[low],w);add("Spelling",w,to,"Common misspelling.");return to;}return w;});

    /* 2) æ‰€æœ‰æ ¼ */
    s = s.replace(/\b(him|her|them)\s+([A-Za-z]+)\b/g,(m,p1,p2)=>{const to=(p1==='him'?'his':p1==='her'?'her':'their')+' '+p2;add("Possessive",m,to,"Use possessive before a noun.");return to;});

    /* 3) a/an */
    s = s.replace(/\b(a)\s+([aeiouAEIOU])/g,(m,a,v)=>{const to='an '+v;add("Article (a/an)",m,to,"Use â€˜anâ€™ before a vowel sound.");return to;});
    s = s.replace(/\b(an)\s+([^aeiouAEIOU\s])/g,(m,an,c1)=>{const to='a '+c1;add("Article (a/an)",m,to,"Use â€˜aâ€™ before a consonant sound.");return to;});

    /* 4) he/she/it ç¬¬ä¸‰äººç¨±å–®æ•¸ */
    s = s.replace(/\b(he|she|it)\s+(go|do|have|say|play|watch|clean|study|try|fly|cry|walk|work|eat|come)\b/gi,(m,subj,verb)=>{
      const v=verb.toLowerCase(); let to=v;
      if(v==='have') to='has'; else if(v==='do') to='does'; else if(v==='go') to='goes';
      else if(/[^aeiou]y$/.test(v)) to=v.slice(0,-1)+'ies';
      else if(/(sh|ch|x|s|o)$/.test(v)) to=v+'es'; else to=v+'s';
      const rep=`${subj} ${to}`; add("Agreement (3rd person)", m, rep, "Third-person singular needs -s/-es."); return rep;
    });

    /* 5) be å‹•è©ä¸€è‡´ */
    s = s.replace(/\bI\s+are\b/gi,()=>{add("Be-verb agreement","I are","I am","â€˜Iâ€™ takes â€˜amâ€™.");return "I am";});
    s = s.replace(/\bI\s+is\b/gi, ()=>{add("Be-verb agreement","I is","I am","â€˜Iâ€™ takes â€˜amâ€™.");return "I am";});
    s = s.replace(/\byou\s+is\b/gi,()=>{add("Be-verb agreement","you is","you are","â€˜youâ€™ takes â€˜areâ€™.");return "you are";});
    s = s.replace(/\bwe\s+is\b/gi, ()=>{add("Be-verb agreement","we is","we are","â€˜weâ€™ takes â€˜areâ€™.");return "we are";});
    s = s.replace(/\bthey\s+is\b/gi,()=>{add("Be-verb agreement","they is","they are","â€˜theyâ€™ takes â€˜areâ€™.");return "they are";});
    s = s.replace(/\b(he|she|it)\s+are\b/gi,(m,subj)=>{const to=`${subj} is`;add("Be-verb agreement",m,to,"he/she/it takes â€˜isâ€™.");return to;});
    /* 5.2) have/has èˆ‡ä¸»è©ä¸€è‡´ï¼ˆI/you/we/they â†’ haveï¼›he/she/it â†’ hasï¼‰ */
    s = s.replace(/\bI\s+has\b/gi,   ()=>{ add("Have/has agreement","I has","I have","â€˜Iâ€™ takes â€˜haveâ€™."); return "I have"; });
    s = s.replace(/\b(you|we|they)\s+has\b/gi,(m,p)=>{ const to=p+" have"; add("Have/has agreement",m,to,"Plural subjects take â€˜haveâ€™."); return to; });
    s = s.replace(/\b(he|she|it)\s+have\b/gi, (m,p)=>{ const to=p+" has";  add("Have/has agreement",m,to,"he/she/it takes â€˜hasâ€™."); return to; });

    /* 5.25) ç¾©å‹™ç”¨æ³•ï¼šhave/has go â†’ have/has to go ï¼ˆä¾‹ï¼šI has go â†’ I have to goï¼‰ */
s = s.replace(/\b(have|has)\s+go\s+to\b/gi, (m, aux) => {
  const rep = `${aux} to go to`;
  add("Obligation (have to)", m, rep, "Use â€˜have/has to go â€¦â€™ for obligation.");
  return rep;
});
s = s.replace(/\b(have|has)\s+go\b/gi, (m, aux) => {
  const rep = `${aux} to go`;
  add("Obligation (have to)", m, rep, "Use â€˜have/has to + base verbâ€™.");
  return rep;
});
    /* 5.25) Present perfectï¼šå…ˆæŠŠå¸¸è¦‹éŒ¯èª¤åˆ†è©ä¿®æ­£æˆåˆç†çš„ V3 å½¢ */
s = s.replace(/\b(have|has)\s+goted\b/gi,   (m, aux)=>{ const rep = `${aux} gotten`; add("Present perfect fix", m, rep, "get â†’ gotten (AmE)"); return rep; });
s = s.replace(/\b(have|has)\s+boughted\b/gi,(m, aux)=>{ const rep = `${aux} bought`; add("Present perfect fix", m, rep, "buy â†’ bought"); return rep; });
s = s.replace(/\b(have|has)\s+([a-z]+?)ieded\b/gi,(m, aux, stem)=>{ const rep = `${aux} ${stem}ied`; add("Present perfect fix", m, rep, "â€¦ieded â†’ â€¦ied"); return rep; });
s = s.replace(/\b(have|has)\s+([a-z]+?)ed(?:ed)\b/gi,(m, aux, stem)=>{ const rep = `${aux} ${stem}ed`; add("Present perfect fix", m, rep, "Remove extra â€˜edâ€™."); return rep; });

    /* 5.26) Present perfectï¼šhave/has + éŒ¯èª¤ ed â†’ æ­£ç¢º V3ï¼ˆç¾å¼ï¼‰ */
(function () {
  // éŒ¯èª¤å¯«æ³• â†’ å°æ‡‰ baseï¼ˆäº¤çµ¦ toPart ç”¢ç”Ÿæ­£ç¢º V3ï¼‰
  const BAD_ED_BASE = {
    "goed":"go", "eated":"eat", "taked":"take", "comed":"come", "runned":"run",
    "sleeped":"sleep", "buyed":"buy", "thinked":"think", "bringed":"bring",
    "catched":"catch", "holded":"hold", "leaved":"leave", "writed":"write",
    "readed":"read", "speaked":"speak", "breaked":"break", "choosed":"choose",
    "sayed":"say", "drived":"drive", "knowed":"know", "gived":"give",
    "finded":"find", "sended":"send", "forgived":"forgive", "forgeted":"forget",
    "growed":"grow"
  };

  s = s.replace(/\b(have|has)\s+([a-z]+)\b/gi, (m, aux, w) => {
    const key = w.toLowerCase();
    if (BAD_ED_BASE[key]) {
      const v3 = toPart(BAD_ED_BASE[key]);       // ä¾‹å¦‚ go â†’ goneï¼ˆç¾å¼ç”¨ gotten for getï¼‰
      const rep = `${aux} ${v3}`;
      add("Present perfect fix", m, rep, "Use the correct past participle (V3).");
      return rep;
    }
    return m;
  });
})();

    /* 5.27) go/gone/went + place â†’ åŠ  toï¼ˆhome ä¾‹å¤–ï¼‰ */
s = s.replace(
  /\b(go|went|gone)\s+(school|work|class|church|library|park|store|market|hospital|office|airport|station|zoo|museum|cinema|theater|beach|farm)\b/gi,
  (m, v, place) => {
    const rep = `${v} to ${place}`;
    add("Preposition", m, rep, "Use â€˜toâ€™ with â€˜goâ€™ + place (except â€˜homeâ€™).");
    return rep;
  }
);
    
  /* 5.3) Present perfect normalizationï¼ˆå…è¨± ed ä¾‹å¤–ï¼Œå¦‚ goedï¼‰ */
(function () {
  const ED_EXCEPT = new Set(["goed","eated","taked","comed","runned","sleeped","buyed","thinked"]);
  s = s.replace(/\b(have|has)\s+(?!to\b)([a-z]+)\b/gi, (m, aux, verb) => {
    const v = verb.toLowerCase();
    // ä¸€èˆ¬çš„è¦å‰‡ ed å°±è·³éï¼Œä½†æŠŠå°‘æ•¸éŒ¯èª¤ ed ä¾‹å¤–æ”¾è¡Œ
    if (/ed$/.test(v) && !ED_EXCEPT.has(v)) return m;

    const base = (v === "got") ? "get" : v;      // got â†’ gottenï¼ˆç¾å¼ï¼‰
    const v3 = toPart(base);
    if (v3 !== v) {
      const rep = `${aux} ${v3}`;
      add("Present perfect normalization", m, rep, "Use past participle (V3) after â€˜have/hasâ€™."); 
      return rep;
    }
    return m;
  });
})();
    /* 6) è¤‡æ•¸ä¸»èª/è¡¨èª */
    s = s.replace(/\bfriends\s+is\b/gi,()=>{add("Plural subject","friends is","friends are","Plural subject takes â€˜areâ€™.");return "friends are";});
    s = s.replace(/\b(people|children|men|women)\s+is\b/gi,(m,p)=>{const to=`${p} are`;add("Plural subject",m,to,"Plural subject takes â€˜areâ€™.");return to;});
    s = s.replace(/\bare\s+vegetarian\b/gi,()=>{add("Plural complement","are vegetarian","are vegetarians","Use plural noun with â€˜areâ€™.");return "are vegetarians";});

    /* 7) äººå + his friends â†’ her/their friends */
    (()=>{
      const female=/^(susan|mary|anna|amy|lisa|jane|kate|linda|sarah|emily|emma|lucy|lily|grace|olivia|sophia|mia|chloe)$/i;
      s = s.replace(/\b([A-Z][a-z]+)\s+and\s+his\s+friends\b/g,(m,name)=>{
        const to=female.test(name)?`${name} and her friends`:`${name} and their friends`;
        add("Pronoun agreement", m, to, "Use proper possessive with the name."); return to;
      });
    })();

    /* 8) å½¢å®¹è©â†’å‰¯è© */
    s = s.replace(/\b(\w+)\s+(careful|quiet|happy|loud|slow|quick|bad|good)\b/gi,(m,verb,adj)=>{
      const a=adj.toLowerCase(); let rep=m;
      if(a==='good'){rep=`${verb} well`;}
      else if(a==='bad'){rep=`${verb} badly`;}
      else if(a!=='fast' && a!=='hard' && a!=='late'){rep=`${verb} ${a}ly`;}
      if(rep!==m){add("Adverb form", m, rep, "Use adverb (â€¦-ly) after a verb.");}
      return rep;
    });

    /* 9) å¸¸è¦‹ä»‹ç³»è© */
    const PREP = [
      [/\bmarried with\b/gi,'married to',"Use â€˜toâ€™ with â€˜marriedâ€™. "],
      [/\bdepend of\b/gi,'depend on',"Use â€˜onâ€™ after â€˜dependâ€™. "],
      [/\binterested on\b/gi,'interested in',"Use â€˜inâ€™ after â€˜interestedâ€™. "],
      [/\bdifferent than\b/gi,'different from',"Prefer â€˜different fromâ€™. "],
      [/\barrive to\b/gi,'arrive at',"Use â€˜atâ€™ with â€˜arriveâ€™. "],
      [/\barrive to home\b/gi,'arrive home',"Drop the preposition with â€˜homeâ€™. "],
      [/\bdiscuss about\b/gi,'discuss',"â€˜Discussâ€™ doesnâ€™t need â€˜aboutâ€™. "],
      [/\blisten (?!to)\b/gi,'listen to',"Use â€˜toâ€™ after â€˜listenâ€™. "],
      [/\bin (Mon|Monday)\b/gi,'on Monday',"Use â€˜onâ€™ for days. "],
      [/\bin (Tue|Tuesday)\b/gi,'on Tuesday',""],
      [/\bin (Wed|Wednesday)\b/gi,'on Wednesday',""],
      [/\bin (Thu|Thursday)\b/gi,'on Thursday',""],
      [/\bin (Fri|Friday)\b/gi,'on Friday',""],
      [/\bin (Sat|Saturday)\b/gi,'on Saturday',""],
      [/\bin (Sun|Sunday)\b/gi,'on Sunday',""],
      [/\bin the morning\b/gi,'in the morning',""],
      [/\bin the afternoon\b/gi,'in the afternoon',""],
      [/\bat night\b/gi,'at night',""]
    ];
    PREP.forEach(([re,to,why])=>{ s = s.replace(re,(m)=>{ add("Preposition", m, to, why); return to; }); });

    /* 9.5) ä¸å®šè© / æƒ…æ…‹å‹•è© å¾Œé¢ä¸€å¾‹ç”¨åŸå½¢ï¼šfixã€Œto slept / to went / can ateã€ç­‰ */
    (function(){
      // å»ºç«‹ã€Œéå»/åˆ†è© â†’ åŸå½¢ã€æŸ¥è¡¨
      const IRR_BASE = {};
      Object.keys(IRR).forEach(base=>{
        const [v2, v3] = IRR[base];
        IRR_BASE[v2] = base;
        IRR_BASE[v3] = base;
      });

      function toBase(w){
        const lw = w.toLowerCase();
        if (IRR_BASE[lw]) return matchCase(IRR_BASE[lw], w); // ä¸è¦å‰‡å‹•è©
        if (/[^aeiou]ied$/i.test(w)) return w.replace(/ied$/i, 'y'); // studied â†’ study
        if (/([bcdfghjklmnpqrstvwxyz])ed$/i.test(w)) return w.replace(/ed$/i, ''); // called â†’ call / cooked â†’ cook
        if (/([sxz]|sh|ch)es$/i.test(w)) return w.replace(/es$/i,''); // watches â†’ watch / goes â†’ go
        if (/ies$/i.test(w)) return w.replace(/ies$/i,'y'); // tries â†’ try
        if (/s$/i.test(w)) return w.replace(/s$/i,''); // plays â†’ play
        return w; // å·²æ˜¯åŸå½¢å°±ä¸å‹•
      }

      // A) to + å‹•è© å¿…é ˆåŸå½¢
      s = s.replace(/\bto\s+([a-z]+)\b/gi, (m, v) => {
        const base = toBase(v);
        if (base !== v) {
          const rep = `to ${base}`;
          add("Infinitive base form", m, rep, "Use the base form after â€˜toâ€™."); 
          return rep;
        }
        return m;
      });

      // B) æƒ…æ…‹/åŠ©å‹•è© + å‹•è© å¿…é ˆåŸå½¢
      s = s.replace(/\b(can|could|will|would|shall|should|may|might|must|let|did|does|do)\s+([a-z]+)\b/gi,
        (m, aux, verb) => {
          const base = toBase(verb);
          if (base !== verb) {
            const rep = `${aux} ${base}`;
            add("Modal base form", m, rep, "Use the base form after a modal/auxiliary.");
            return rep;
          }
          return m;
        }
      );
    })();

    /* 10) é›™é‡å¦å®š */
    s = s.replace(/\b(don't|do not|doesn't|does not|didn't|did not)\s+([a-z]+)\s+no\b/gi,(m,aux,verb)=>{const to=`${aux} ${verb} any`;add("Double negative",m,to,"Use â€˜anyâ€™ with a negative.");return to;});

    /* 11) éå»å¼ï¼ˆé… past markersï¼‰ */
    const pastMark=/\b(yesterday|last\s+(night|week|month|year|mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)|\d+\s+(minute|hour|day|week|month|year)s?\s+ago|ago)\b/i;
    if(pastMark.test(s)){
      const PAST_SET=new Set(Object.values(IRR).map(a=>a[0]));
      // ä¸»èªä»£åè©
      s=s.replace(/\b(I|he|she|we|they|you)\s+(?:do not|don't|does not|doesn't)?\s*([a-z]+)\b/gi,(m,subj,verb)=>{
        const v=verb.toLowerCase();
        if(PAST_SET.has(v)||/(ed|t)$/.test(v)||/^(am|is|are|was|were|been|be|have|has|had|do|does|did|will)$/i.test(v)) return m;
        const to=`${subj} ${toPast(v)}`; add("Past tense",`${subj} ${verb}`,to,"Use past tense with past-time markers."); return to;
      });
      // A) å°ˆæœ‰åè©ä¸»èªï¼ˆJo/Tomâ€¦ï¼‰
      s = s.replace(/\b([A-Z][a-z]+)\s+([a-z]+)\b/g,(m,name,verb)=>{
        const v=verb.toLowerCase();
        if (/^(am|is|are|was|were|been|be|have|has|had|do|does|did|will|can|should|would|might|must)$/.test(v)) return m;
        if (/(ed|t)$/.test(v)) return m;
        const to = IRR[v]? IRR[v][0] : (v.endsWith("e")? v+"d" : /[^aeiou]y$/.test(v)? v.slice(0,-1)+"ied" : v+"ed");
        add("Past tense (proper noun subject)", `${name} ${verb}`, `${name} ${to}`, "Use past tense with past-time markers.");
        return `${name} ${to}`;
      });
      // B) é€£æ¥è©å¾Œçš„ç¬¬äºŒå‹•è©ï¼ˆand/then/,ï¼‰
      s = s.replace(/\b(?:and|then|,)\s+([a-z]+)\b/gi,(m,verb)=>{
        const v=verb.toLowerCase();
        if (/^(am|is|are|was|were|been|be|have|has|had|do|does|did|will|can|should|would|might|must)$/.test(v)) return m;
        if (/(ed|t)$/.test(v) || (IRR[v] && IRR[v][0]===v)) return m;
        const to = IRR[v]? IRR[v][0] : (v.endsWith("e")? v+"d" : /[^aeiou]y$/.test(v)? v.slice(0,-1)+"ied" : v+"ed");
        add("Past tense (second verb in sequence)", verb, to, "All verbs in a past sequence should be past tense.");
        return m.replace(new RegExp(verb+'$','i'), to);
      });
    }

    /* 11.5-EXT) Present Perfect å¸¸è¦‹éŒ¯èª¤ V3 å°ç…§ï¼ˆç¾å¼ï¼‰ */
    (function(){
      // å¸¸è¦‹éŒ¯å¯« â†’ æ­£ç¢º V3ï¼ˆç¾å¼ç”¨ gottenï¼‰
      const MIST_V3 = {
        "buyed":"bought","thinked":"thought","maked":"made","doed":"done","go-ed":"gone","writed":"written",
        "speaked":"spoken","eated":"eaten","breaked":"broken","bringed":"brought","builded":"built",
        "catched":"caught","costed":"cost","cutted":"cut","feeded":"fed","finded":"found","gived":"given",
        "hitted":"hit","holded":"held","keeped":"kept","leaded":"led","leaved":"left","losed":"lost",
        "payed":"paid","putted":"put","readed":"read","runned":"run","sayed":"said","sended":"sent",
        "singed":"sung","ringed":"rung","springed":"sprung","sitted":"sat","sleeped":"slept","spended":"spent",
        "standed":"stood","teached":"taught","telled":"told","understanded":"understood",
        "weared":"worn","winned":"won","growed":"grown","knowed":"known","drived":"driven","forgived":"forgiven",
        "forgeted":"forgotten","dranked":"drunk","drinked":"drunk","swimed":"swum","flew":"flown",
        "throwed":"thrown","choosed":"chosen","begined":"begun","becomed":"become","comed":"come",
        "getted":"gotten","goted":"gotten","spoke":"spoken","went":"gone",
        "studieded":"studied","decideded":"decided","improveded":"improved","calleded":"called","cookeded":"cooked",
        "returneded":"returned","useded":"used","playeded":"played","boughted":"bought","taked":"taken",
        "sawed":"seen","seed":"seen","writen":"written","writted":"written"
      };

      // have/has + <éŒ¯å¯«> â†’ have/has + æ­£ç¢ºV3
      s = s.replace(/\b(have|has)\s+([a-z\-]+)\b/gi, (m, aux, w) => {
        const low = w.toLowerCase();
        if (MIST_V3[low]) {
          const to = `${aux} ${MIST_V3[low]}`;
          add("Present perfect (table fix)", m, to, "Normalize to the correct past participle (AmE).");
          return to;
        }
        return m;
      });

      // have/has + éå»å¼ï¼ˆV2ï¼‰â†’ have/has + æ­£ç¢ºV3ï¼ˆç”¨ IRR æŸ¥ï¼‰
      const V2toBase = {};
      Object.keys(IRR).forEach(base=>{
        const [v2] = IRR[base];
        V2toBase[v2] = base;
      });
      s = s.replace(/\b(have|has)\s+([a-z]+)\b/gi, (m, aux, v) => {
        const low = v.toLowerCase();
        if (V2toBase[low]) {
          const base = V2toBase[low];
          const v3 = (IRR[base][1] || IRR[base][0]); // ç¾å¼ï¼šget â†’ gotten
          const to = `${aux} ${v3}`;
          if (v3 !== low) {
            add("Present perfect (V2â†’V3)", m, to, "Use past participle (V3) after â€˜have/hasâ€™."); 
            return to;
          }
        }
        return m;
      });
    })();

    /* 12) ç¾åœ¨å®Œæˆå¼ï¼ˆç„¡æ˜ç¢ºéå»æ™‚é–“ï¼‰ */
    const perfMark=/\b(already|yet|ever|never|just|recently|lately|since\s+\d{4}|\bsince\b|for\s+\d+\s+(minute|hour|day|week|month|year)s?|so far|in the last|in recent (days|weeks|months|years))\b/i;
    if(perfMark.test(s) && !pastMark.test(s)){
      // æ­£å¸¸ï¼šæ”¹æˆ have/has + V3
      s = s.replace(/\b(I|we|they|you)\s+(?:did|do|does)?\s*([a-z]+)\b/gi,(m,subj,verb)=>{const to=`${subj} have ${toPart(verb.toLowerCase())}`;add("Present perfect",m,to,"Use â€˜have/has + past participleâ€™.");return to;});
      s = s.replace(/\b(he|she|it)\s+(?:did|do|does)?\s*([a-z]+)\b/gi,(m,subj,verb)=>{const to=`${subj} has ${toPart(verb.toLowerCase())}`;add("Present perfect",m,to,"Use â€˜have/has + past participleâ€™.");return to;});
      /* â† å·²ç§»é™¤ï¼šæŠŠéŒ¯èª¤å®Œæˆå¼é€€å›éå»å¼çš„ 6 è¡Œè¡çªä¿éšª */
    }

    /* 13) æœªä¾†å¼ */
    const futureMark=/\b(tomorrow|next\s+(week|month|year|mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)|soon|in\s+\d+\s+(minutes?|hours?|days?|weeks?|months?|years?))\b/i;
    if(futureMark.test(s) && !/\b(will|going to|be going to|plan to|intend to)\b/i.test(s)){
      s=s.replace(/\b(I|he|she|it|we|they|you)\s+([a-z]+)\b/gi,(m,subj,verb)=>{
        const v=verb.toLowerCase(); if(/^(am|is|are|was|were|been|be|have|has|had|do|does|did|will)$/i.test(v)) return m;
        const to=`${subj} will ${v}`; add("Future",m,to,"Use â€˜willâ€™ for clear future time."); return to;
      });
    }

    /* 14) å–®æ•¸ä¸»èª + è¤‡æ•¸è¡¨èª â†’ å–®æ•¸åè© */
    const SINGULARIZE={"boys":"boy","girls":"girl","students":"student","teachers":"teacher","friends":"friend","cats":"cat","dogs":"dog","books":"book","apples":"apple"};
    s = s.replace(/\b(I|he|she|it)\s+(am|is)\s+([a-z]+(?:\s+[a-z]+)*)?\s*\b([a-z]+s)\b/gi,(m,subj,be,adj="",plural)=>{
      const low=plural.toLowerCase(); if(!SINGULARIZE[low]) return m;
      const to=`${subj} ${be} a ${adj?adj.trim()+" ":""}${SINGULARIZE[low]}`;
      add("Predicate number", m.trim(), to.trim(), "Singular subject â†’ singular complement."); return to;
    });

    /* 15) ç¸®å¯«ï¼ˆæ”¾åœ¨å–®æ•¸è£œæ­£ä¹‹å¾Œï¼‰ */
    s = s.replace(/\bI am\b/g, ()=>{ add("Contraction","I am","I'm","Use common contraction."); return "I'm"; });

    /* 16) ç©ºç™½/æ¨™é» */
    const beforeClean=s; s=s.replace(/ {2,}/g,' ').replace(/\s+([,.!?;:])/g,'$1');
    if(s!==beforeClean){ add("Punctuation spacing","extra space","cleaned","Remove extra spaces before punctuation."); }

    return { text:s, count, changes };
  }

  async function grammarPipeline(text){
    const lt1 = await applyLanguageToolOnceDetailed(text);
    const local = localFixOnce(lt1.text);
    const lt2 = await applyLanguageToolOnceDetailed(local.text);
    const finalText = lt2.text;
    const total = lt1.count + local.count + lt2.count;
    const changes = [...lt1.changes, ...local.changes, ...lt2.changes];
    return { text:finalText, total, ltCount:lt1.count+lt2.count, localCount:local.count, changes };
  }

  /* ========== äº‹ä»¶ ========== */
  ui.zh2en.addEventListener('click', async()=>{
    const txt=ui.inputZh.value.trim(); if(!txt) return;
    setStatus("ç¿»è­¯ä¸­ï¼ˆä¸­â†’è‹±ï¼‰â€¦");
    ui.outputEn.value=await translateSmart(txt,"zh-en");
    setStatus("âœ… å®Œæˆï¼šä¸­æ–‡â†’è‹±æ–‡");
  });
  ui.en2zh.addEventListener('click', async()=>{
    const txt=ui.outputEn.value.trim(); if(!txt) return;
    setStatus("ç¿»è­¯ä¸­ï¼ˆè‹±â†’ç¹é«”ä¸­æ–‡ï¼‰â€¦");
    ui.outputEn.value=await translateSmart(txt,"en-zh");
    setStatus("âœ… å®Œæˆï¼šè‹±æ–‡â†’ä¸­æ–‡(ç¹é«”)");
  });

  ui.check.addEventListener('click', async()=>{
    const before = ui.outputEn.value.trim(); if(!before) return;
    setStatus("Grammar æª¢æŸ¥ä¸­â€¦");
    const res = await grammarPipeline(before);
    ui.outputEn.value = res.text;

    const d = diffHL(before, res.text);
    if(res.text!==before){
      ui.origHL.innerHTML = d.origHL;
      ui.corrHL.innerHTML = d.corrHL;
      ui.review.style.display = "block";
    }else{
      ui.review.style.display = "none";
    }
    renderSuggestions(res.changes);
    setStatus(`âœ… å®Œæˆï¼šGrammar checkï¼ˆä¿®æ­£ ${res.total} è™•ï½œLTï¼š${res.ltCount}ï¼Œæœ¬åœ°ï¼š${res.localCount}ï¼‰`);
  });

  ui.clearZh.addEventListener('click',()=>ui.inputZh.value="");
  ui.clearEn.addEventListener('click',()=>ui.outputEn.value="");

  ui.save.addEventListener('click',()=>{
    const blob=new Blob([document.documentElement.outerHTML],{type:"text/html;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="tran-kids-grammar-pro.html"; a.click();
    URL.revokeObjectURL(url);
  });

  ui.diag.addEventListener('click', async()=>{
    setStatus("ğŸ” è¨ºæ–·ä¸­â€¦");
    const results = [];
    try{
      const r = await fetchWithTimeout("https://api.mymemory.translated.net/get?q=hello&langpair=en|zh-TW", {}, 6000);
      results.push(`MyMemory: ${r.ok ? "âœ… OK" : "âŒ " + r.status}`);
    }catch(e){ results.push("MyMemory: âŒ ç„¡æ³•é€£ç·š"); }
    for(const node of LT_NODES){
      try{
        const r = await fetchWithTimeout(node + "/languages", {}, 6000);
        results.push(`${new URL(node).host}: ${r.ok ? "âœ… OK" : "âŒ " + r.status}`);
      }catch(e){
        results.push(`${new URL(node).host}: âŒ ç„¡æ³•é€£ç·š`);
      }
    }
    setStatus("è¨ºæ–·çµæœï½œ" + results.join(" ï½œ "));
  });
})();
</script>
</body>
</html>
