<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Miss K English class</title>

<style>
/* Kids Yellow Theme â€” inline overrideï¼ˆç¯€éŒ„ï¼‰ */
:root{
  --kids-bg:#FFF7CC; --kids-panel:#FFE680; --kids-panel-2:#FFEF99;
  --kids-accent:#FFB703; --kids-accent-2:#FB8500; --kids-text:#3A2D00;
  --kids-muted:#6B5600; --kids-border:#FFD259; --kids-shadow:0 6px 18px rgba(160,120,0,.18);
  --kids-radius:12px;
}
body{ background:var(--kids-bg)!important; color:var(--kids-text)!important;
  font-family:"Comic Sans MS","Noto Sans TC","Microsoft JhengHei",system-ui,Arial,sans-serif!important; line-height:1.6; }
header{ background:linear-gradient(180deg,var(--kids-panel),var(--kids-panel-2))!important;
  border-bottom:2px dashed var(--kids-border)!important; box-shadow:var(--kids-shadow)!important;
  padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
h1{ color:var(--kids-text)!important; font-size:18px; margin:0; } h1::before{ content:"ğŸ¦"; margin-right:6px; }
.btn{ padding:10px 14px!important; border:2px solid var(--kids-border)!important; border-radius:20px!important;
  background:#fff8d9!important; color:var(--kids-text)!important; box-shadow:var(--kids-shadow)!important; font-weight:700!important; }
.btn.primary{ background:var(--kids-accent)!important; border-color:var(--kids-accent-2)!important; color:#1b1100!important; }
textarea{ width:100%; height:220px; border-radius:14px!important; border:2px solid var(--kids-border)!important;
  background:#fffef5!important; color:var(--kids-text)!important; font-size:15px!important; padding:10px; }
#status{ border:2px dashed var(--kids-border)!important; border-radius:var(--kids-radius)!important;
  background:#fff7d1!important; color:var(--kids-text)!important; box-shadow:var(--kids-shadow)!important; padding:12px; margin:18px; }
.grid{ display:grid; gap:14px; margin:18px; } @media(min-width:800px){ .grid{ grid-template-columns:1fr 1fr; } }
.panel{ background:#fffbea; border:2px solid var(--kids-border); border-radius:var(--kids-radius); padding:14px; box-shadow:var(--kids-shadow); }
label{ display:block; margin-bottom:8px; font-weight:900; color:var(--kids-muted); }

/* é«˜äº®æ¨£å¼ */
.hl-container{ border:2px dashed var(--kids-border); border-radius:12px; padding:12px; background:#fffef7; }
.hl-line{ margin:6px 0; }
.hl-del{ background:#ffe3e3; text-decoration:line-through; border-radius:6px; padding:0 2px; }
.hl-ins{ background:#ddf8dd; border-bottom:2px solid #2d8a2d; border-radius:6px; padding:0 2px; }
.small{ font-size:13px; color:#5f4b00; }
#review{ display:none; }
#review .title{ display:flex; justify-content:space-between; align-items:center; }
#review .toggle{ cursor:pointer; font-weight:700; }
ol.suggest{ padding-left:20px; }
body::after{ content:" ğŸ»ğŸ°ğŸ¦Š ä¸€èµ·å­¸èªè¨€ï¼ "; position:fixed; right:10px; bottom:10px; background:#fff;
  border:2px solid var(--kids-border); border-radius:14px; padding:8px 10px; box-shadow:var(--kids-shadow); font-weight:800; color:var(--kids-text); }
</style>
</head>

<body>
<header>
  <h1>Miss K EnglishClass</h1>
  
</header>

<div class="grid">
  <div class="panel">
    <label>ä¸­æ–‡</label>
    <textarea id="inputZh" placeholder="è¼¸å…¥ä¸­æ–‡"></textarea>
    <div class="row">
      <button id="btnZhEn" class="btn primary">ä¸­æ–‡ âœ è‹±æ–‡</button>
      <button id="btnClearZh" class="btn">æ¸…ç©º</button>
    </div>
  </div>

  <div class="panel">
    <label>English</label>
    <textarea id="outputEn" placeholder="ç¿»è­¯çµæœ"></textarea>
    <div class="row">
      <button id="btnEnZh" class="btn primary">è‹±æ–‡ âœ ä¸­æ–‡(ç¹é«”)</button>
      <button id="btnCheck" class="btn">Grammar</button>
      <button id="btnClearEn" class="btn">æ¸…ç©º</button>
    </div>
  </div>
</div>

<div id="status">âœ¨ ç›´æ¥è¼¸å…¥ä¸­æ–‡æˆ–è‹±æ–‡å³å¯ã€‚</div>

<!-- ä¿®æ­£ç´°ç¯€ -->
<div id="review" class="panel">
  <div class="title">
    <strong>ğŸ›  ä¿®æ­£ç´°ç¯€</strong>
    <button id="btnToggleReview" class="btn">æ”¶åˆ/å±•é–‹</button>
  </div>
  <p class="small">ä¸Šæ–¹é¡¯ç¤ºã€ŒåŸå¥ï¼ˆé«˜äº®ï¼‰ã€èˆ‡ã€Œä¿®æ­£æ–‡ã€ã€‚ç´…è‰²åˆªé™¤ï¼Œç¶ è‰²æ–°å¢ã€‚</p>
  <div class="hl-container">
    <div class="hl-line"><strong>åŸå¥ï¼š</strong> <span id="origHL"></span></div>
    <div class="hl-line"><strong>ä¿®æ­£æ–‡ï¼š</strong> <span id="corrHL"></span></div>
  </div>
  <h4>å»ºè­°æ¸…å–®</h4>
  <ol id="suggestList" class="suggest"></ol>
</div>

<script>
(function(){
  const ui = {
    inputZh: document.getElementById('inputZh'),
    outputEn: document.getElementById('outputEn'),
    zh2en: document.getElementById('btnZhEn'),
    en2zh: document.getElementById('btnEnZh'),
    check: document.getElementById('btnCheck'),
    clearZh: document.getElementById('btnClearZh'),
    clearEn: document.getElementById('btnClearEn'),
    status: document.getElementById('status'),
    save: document.getElementById('btnSave'),
    diag: document.getElementById('btnDiag'),
    review: document.getElementById('review'),
    btnToggleReview: document.getElementById('btnToggleReview'),
    origHL: document.getElementById('origHL'),
    corrHL: document.getElementById('corrHL'),
    suggestList: document.getElementById('suggestList')
  };

  function setStatus(msg){ ui.status.textContent = msg; }

  async function libreTranslate(text, target){
    const res = await fetch("https://libretranslate.de/translate", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ q:text, source:"auto", target:target, format:"text" })
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();
    return data.translatedText;
  }
  async function myMemory(text, source, target){
    const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${source}|${target}`;
    const r=await fetch(url); const j=await r.json();
    return j?.responseData?.translatedText || "";
  }
  async function translateSmart(text, dir){
    try{
      return await libreTranslate(text, dir==="zh-en"?"en":"zh-TW");
    }catch(e){
      setStatus("âš ï¸ é‡æ–°è¼¸å…¥ã€‚");
      return await myMemory(text, dir==="zh-en"?"zh-CN":"en", dir==="zh-en"?"en":"zh-TW");
    }
  }

  // ==== Grammar with highlight ====
  function applySuggestionsFromEnd(src, matches){
    const ms = matches.filter(m => m.replacements && m.replacements.length)
                      .sort((a,b)=> (b.offset) - (a.offset));
    let out = src;
    for(const m of ms){
      const rep = m.replacements[0].value;
      out = out.slice(0, m.offset) + rep + out.slice(m.offset + m.length);
    }
    return out;
  }

  function buildHighlightFromMatches(original, matches){
    // ä»¥ matches ç”¢ç”Ÿã€ŒåŸå¥é«˜äº®ã€ï¼šåŸæ–‡å­— + <ins>å»ºè­°</ins>
    let html = "", cursor = 0;
    const sorted = [...matches].sort((a,b)=>a.offset - b.offset);
    for(const m of sorted){
      const start = m.offset, end = m.offset + m.length;
      const rep = (m.replacements && m.replacements[0]) ? m.replacements[0].value : "";
      html += escapeHTML(original.slice(cursor, start));
      const oldPart = escapeHTML(original.slice(start, end));
      const newPart = escapeHTML(rep);
      html += `<span class="hl-del">${oldPart}</span>` + (newPart ? ` <span class="hl-ins">${newPart}</span>` : "");
      cursor = end;
    }
    html += escapeHTML(original.slice(cursor));
    return html;
  }

  function buildSimpleDiff(oldText, newText){
    // Fallbackï¼šæ‰¾å‡ºé¦–æœ«å·®ç•°å€å¡Šï¼Œåšä¸€æ¬¡æ›¿æ›é«˜äº®ï¼ˆç°¡å–®ä½†é —ç›´è¦ºï¼‰
    if(oldText === newText) return {orig: escapeHTML(oldText), corr: escapeHTML(newText)};
    let s = 0, eOld = oldText.length - 1, eNew = newText.length - 1;
    while(s <= eOld && s <= eNew && oldText[s] === newText[s]) s++;
    while(eOld >= s && eNew >= s && oldText[eOld] === newText[eNew]){ eOld--; eNew--; }
    const orig = escapeHTML(oldText.slice(0,s)) +
                 `<span class="hl-del">${escapeHTML(oldText.slice(s,eOld+1))}</span>` +
                 escapeHTML(oldText.slice(eOld+1));
    const corr = escapeHTML(newText.slice(0,s)) +
                 `<span class="hl-ins">${escapeHTML(newText.slice(s,eNew+1))}</span>` +
                 escapeHTML(newText.slice(eNew+1));
    return {orig, corr};
  }

  function escapeHTML(s){
    return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
  }

  async function grammarCheck(text){
    if(!text || !text.trim()) return text;

    try{
      // èª¿ LanguageTool
      const p=new URLSearchParams();
      p.append("text",text);
      p.append("language","en-US");
      p.append("enabledCategories","GRAMMAR,CONFUSED_WORDS,TYPOGRAPHY,PUNCTUATION");
      const r=await fetch("https://api.languagetool.org/v2/check", {
        method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body:p
      });
      if(!r.ok) throw new Error("HTTP "+r.status);
      const j=await r.json();

      if(!j.matches || !j.matches.length){
        // ç„¡å»ºè­°ï¼šé¡¯ç¤ºåŸå¥
        ui.origHL.innerHTML = escapeHTML(text);
        ui.corrHL.innerHTML = escapeHTML(text);
        ui.suggestList.innerHTML = "<li>æ²’æœ‰ç™¼ç¾éœ€è¦ä¿®æ”¹çš„åœ°æ–¹ ğŸ‰</li>";
        ui.review.style.display = "block";
        return text;
      }

      // 1) ç”¢ç”Ÿä¿®æ­£æ–‡
      const corrected = applySuggestionsFromEnd(text, j.matches);

      // 2) åŸå¥é«˜äº®ï¼ˆé¡¯ç¤ºèˆŠâ†’æ–°ï¼‰
      ui.origHL.innerHTML = buildHighlightFromMatches(text, j.matches);

      // 3) ä¿®æ­£æ–‡é«˜äº®ï¼ˆå–®ç´”é¡¯ç¤ºä¿®æ­£æ–‡ï¼‰
      ui.corrHL.innerHTML = escapeHTML(corrected);

      // 4) å»ºè­°æ¸…å–®
      ui.suggestList.innerHTML = j.matches.map(m=>{
        const rep = (m.replacements && m.replacements[0]) ? m.replacements[0].value : "";
        const bad = escapeHTML(text.substr(m.offset, m.length));
        const msg = escapeHTML(m.message || "");
        const rule = escapeHTML((m.rule && (m.rule.description || m.rule.id)) || "Suggestion");
        return `<li><strong>${rule}</strong>ï¼š${msg}<br>
          <span class="small">â†’ <span class="hl-del">${bad}</span> æ”¹ç‚º <span class="hl-ins">${escapeHTML(rep)}</span></span></li>`;
      }).join("");

      ui.review.style.display = "block";
      setStatus("âœ… å®Œæˆï¼šGrammar checkï¼ˆä¿®æ­£ "+j.matches.length+" è™•ï¼‰");
      return corrected;

    }catch(e){
      // API å¤±æ•—ï¼šç”¨ç°¡å–®è¦å‰‡ä¿®ä¸€ä¸‹ï¼Œä¸¦åšç°¡å–®é«˜äº®
      const lf = localFix(text);
      const diff = buildSimpleDiff(text, lf.text);
      ui.origHL.innerHTML = diff.orig;
      ui.corrHL.innerHTML = diff.corr;
      ui.suggestList.innerHTML = `<li>é›¢ç·šç°¡æ˜“ä¿®æ­£ï¼Œå…± ${lf.count} è™•ã€‚</li>`;
      ui.review.style.display = "block";
      setStatus("âš ï¸ é›¢ç·š Grammarï¼šå·²å¥—ç”¨ç°¡æ˜“ä¿®æ­£ "+lf.count+" è™•");
      return lf.text;
    }
  }

  function localFix(src){
    let s = src, c = 0;
    const rules = [
      {re:/\b(him|her|them)\s+([A-Za-z]+)\b/g, fn:(m,p1,p2)=>{ c++; return (p1=='him'?'his':p1=='her'?'her':'their')+' '+p2; }},
      {re:/\b(a)\s+([aeiouAEIOU])/g, fn:(m,a,v)=>{ c++; return 'an '+v; }},
      {re:/\b(an)\s+([^aeiouAEIOU\s])/g, fn:(m,an,cons)=>{ c++; return 'a '+cons; }},
      {re:/ {2,}/g, fn:()=>{ c++; return ' '; }},
      {re:/\b(you|they)\s+was\b/gi, fn:(m,subj)=>{ c++; return subj+' were'; }},
      {re:/(^|[.!?]\s+)([a-z])/g, fn:(m,pre,ch)=>{ c++; return pre+ch.toUpperCase(); }}
    ];
    for(const r of rules){ s = s.replace(r.re, r.fn); }
    return { text: s, count: c };
  }

  // ==== UI ç¶å®š ====
  ui.zh2en.addEventListener('click', async()=>{ 
    const txt=ui.inputZh.value.trim(); if(!txt) return;
    setStatus("ç¿»è­¯ä¸­ï¼ˆä¸­â†’è‹±ï¼‰â€¦");
    ui.outputEn.value=await translateSmart(txt,"zh-en");
    setStatus("âœ… å®Œæˆï¼šä¸­æ–‡â†’è‹±æ–‡");
  });
  ui.en2zh.addEventListener('click', async()=>{
    const txt=ui.outputEn.value.trim(); if(!txt) return;
    setStatus("ç¿»è­¯ä¸­ï¼ˆè‹±â†’ç¹é«”ä¸­æ–‡ï¼‰â€¦");
    ui.outputEn.value=await translateSmart(txt,"en-zh");
    setStatus("âœ… å®Œæˆï¼šè‹±æ–‡â†’ä¸­æ–‡(ç¹é«”)");
  });
  ui.check.addEventListener('click', async()=>{
    const txt=ui.outputEn.value.trim(); if(!txt) return;
    setStatus("æ–‡æ³•æª¢æŸ¥ä¸­â€¦");
    ui.outputEn.value=await grammarCheck(txt);
  });
  ui.clearZh.addEventListener('click',()=>ui.inputZh.value="");
  ui.clearEn.addEventListener('click',()=>ui.outputEn.value="");
  ui.save.addEventListener('click',()=>{
    const blob=new Blob([document.documentElement.outerHTML],{type:"text/html;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="translator-kids-highlight.html"; a.click();
    URL.revokeObjectURL(url);
  });
  ui.diag.addEventListener('click', async()=>{
    try{
      const r=await fetch("https://libretranslate.de/");
      setStatus("è¨ºæ–·ï¼šLibreTranslate "+(r.ok?"å¯ç”¨":"å¤±æ•—")+" | HTTP "+r.status);
    }catch(e){ setStatus("è¨ºæ–·ï¼šè«‹æ±‚å¤±æ•—"); }
  });

  ui.btnToggleReview.addEventListener('click', ()=>{
    ui.review.classList.toggle('closed');
    ui.review.style.display = (ui.review.style.display==='none'?'block':'none');
  });
})();
</script>
</body>
</html>
