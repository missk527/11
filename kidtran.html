<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Miss K English class</title>
<style>
:root{
  --kids-bg:#FFF7CC; --kids-panel:#FFE680; --kids-panel-2:#FFEF99;
  --kids-accent:#FFB703; --kids-accent-2:#FB8500; --kids-text:#3A2D00;
  --kids-muted:#6B5600; --kids-border:#FFD259; --kids-shadow:0 6px 18px rgba(160,120,0,.18);
  --kids-radius:12px;
}
body{
  background:var(--kids-bg); color:var(--kids-text);
  font-family:"Comic Sans MS","Noto Sans TC","Microsoft JhengHei",system-ui,Arial,sans-serif;
  line-height:1.6; padding-bottom:110px;
}
header{ background:linear-gradient(180deg,var(--kids-panel),var(--kids-panel-2));
  border-bottom:2px dashed var(--kids-border); box-shadow:var(--kids-shadow);
  padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
h1{ color:var(--kids-text); font-size:18px; margin:0; } h1::before{ content:"🦁"; margin-right:6px; }
.btn{ padding:10px 14px; border:2px solid var(--kids-border); border-radius:20px;
  background:#fff8d9; color:#3A2D00; box-shadow:var(--kids-shadow); font-weight:700; }
.btn.primary{ background:var(--kids-accent); border-color:var(--kids-accent-2); color:#1b1100; }
textarea{ width:100%; height:220px; border-radius:14px; border:2px solid var(--kids-border);
  background:#fffef5; color:#3A2D00; font-size:15px; padding:10px; }
#status{ border:2px dashed var(--kids-border); border-radius:var(--kids-radius);
  background:#fff7d1; color:#3A2D00; box-shadow:var(--kids-shadow); padding:12px; margin:18px; }
.grid{ display:grid; gap:14px; margin:18px; } @media (min-width:800px){ .grid{ grid-template-columns:1fr 1fr; } }
.panel{ background:#fffbea; border:2px solid var(--kids-border); border-radius:var(--kids-radius);
  padding:14px; box-shadow:var(--kids-shadow); }
label{ display:block; margin-bottom:8px; font-weight:900; color:#6B5600; }

/* 高亮差異 */
.hl-del{ background:#ffe3e3; text-decoration:line-through; border-radius:6px; padding:0 4px; }
.hl-ins{ background:#ddf8dd; border-bottom:2px solid #2d8a2d; border-radius:6px; padding:0 4px; }
.small{ font-size:13px; color:#5f4b00; }

/* 修正細節卡片 */
#review{ display:none; margin:18px; }
#review .card{ background:#fffef5; border:2px solid var(--kids-border); border-radius:var(--kids-radius); padding:14px; box-shadow:var(--kids-shadow); }
.suggest{ margin:8px 0 0 22px; }
.suggest li{ margin:10px 0; }
.chip-old{ background:#ffe3e3; border-radius:6px; padding:0 6px; }
.chip-new{ background:#ddf8dd; border-radius:6px; padding:0 6px; border-bottom:2px solid #2d8a2d; }

/* 右下貼紙（不擋點擊） */
body::after{
  content:" 🐻🐰🦊 一起學English！ ";
  position:fixed; right:10px; bottom:8px;
  background:#fff; border:2px solid var(--kids-border); border-radius:14px;
  padding:8px 10px; box-shadow:var(--kids-shadow);
  font-weight:800; color:#3A2D00;
  transform:scale(.9); pointer-events:none;
}
</style>
</head>
<body>
<header>
  <h1>Miss K English class</h1>
</header>

<div class="grid">
  <div class="panel">
    <label>中文</label>
    <textarea id="inputZh" placeholder="輸入中文"></textarea>
    <div class="row" style="margin-top:8px; display:flex; gap:10px;">
      <button id="btnZhEn" class="btn primary">中文 ➜ 英文</button>
      <button id="btnClearZh" class="btn">清空</button>
    </div>
  </div>

  <div class="panel">
    <label>English</label>
    <textarea id="outputEn" placeholder="翻譯結果 / 要檢查的英文"></textarea>
    <div class="row" style="margin-top:8px; display:flex; gap:10px;">
      <button id="btnEnZh" class="btn primary">英文 ➜ 中文</button>
      <button id="btnCheck" class="btn">Grammar</button>
      <button id="btnClearEn" class="btn">清空</button>
    </div>
  </div>
</div>

<div id="status">✨ 直接輸入中文或英文即可。</div>

<div id="review">
  <div class="card">
    <strong>🛠 修正細節</strong>
    <p class="small">上方顯示「原句（紅色刪除）」與「修正文（綠色新增）」。</p>
    <div><strong>原句：</strong> <span id="origHL"></span></div>
    <div><strong>修正文：</strong> <span id="corrHL"></span></div>

    <hr style="border:none;border-top:1px dashed #e6c55b;margin:12px 0;">
    <div>
      <strong>📝 建議清單</strong>
      <ol id="suggestList" class="suggest"></ol>
    </div>
  </div>
</div>

<script>
  /* ================== Grammar engine (LT + Local rules) ================== */
/* 若你檔案已經有 IRR / toPast / toPart，保留你原本的即可；否則這裡提供一份 */
const IRR = {
  "am":["was","been"], "is":["was","been"], "are":["were","been"],
  "do":["did","done"], "does":["did","done"], "go":["went","gone"],
  "come":["came","come"], "eat":["ate","eaten"], "see":["saw","seen"],
  "take":["took","taken"], "make":["made","made"], "have":["had","had"], "has":["had","had"],
  "get":["got","gotten"], "give":["gave","given"], "write":["wrote","written"],
  "read":["read","read"], "run":["ran","run"], "sleep":["slept","slept"],
  "feel":["felt","felt"], "leave":["left","left"], "meet":["met","met"],
  "pay":["paid","paid"], "put":["put","put"], "say":["said","said"],
  "buy":["bought","bought"], "bring":["brought","brought"], "think":["thought","thought"],
  "teach":["taught","taught"], "begin":["began","begun"], "become":["became","become"],
  "find":["found","found"], "hold":["held","held"], "keep":["kept","kept"],
  "speak":["spoke","spoken"], "drink":["drank","drunk"], "drive":["drove","driven"],
  "forget":["forgot","forgotten"], "forgive":["forgave","forgiven"], "grow":["grew","grown"],
  "know":["knew","known"], "lose":["lost","lost"], "send":["sent","sent"],
  "sit":["sat","sat"], "stand":["stood","stood"], "understand":["understood","understood"],
  "win":["won","won"], "cut":["cut","cut"], "hit":["hit","hit"], "hurt":["hurt","hurt"], "let":["let","let"], "set":["set","set"], "cost":["cost","cost"]
};
function toPast(v){
  const x=v.toLowerCase(); if(IRR[x]) return IRR[x][0];
  if(/[^aeiou]y$/.test(x)) return x.slice(0,-1)+"ied";
  if(x.endsWith("e")) return x+"d";
  return x+"ed";
}
function toPart(v){
  const x=v.toLowerCase(); if(IRR[x]) return IRR[x][1]||IRR[x][0];
  if(/[^aeiou]y$/.test(x)) return x.slice(0,-1)+"ied";
  if(x.endsWith("e")) return x+"d";
  return x+"ed";
}

/* 小字典（常見拼字） */
const SPELL = {
  "becuase":"because","recieve":"receive","seperate":"separate","definately":"definitely",
  "wierd":"weird","adress":"address","enviroment":"environment","tomatos":"tomatoes",
  "alot":"a lot","occured":"occurred","wich":"which","thier":"their","beleive":"believe",
  "freind":"friend","studing":"studying","untill":"until","sory":"sorry","conisder":"consider",
  "consder":"consider","considre":"consider","improvment":"improvement"
};

/* ————— Local rules pass ————— */
function localFixOnce(src){
  let s=src, count=0; const changes=[];
  const add=(title,from,to,msg="")=>{ if(from!==to){ count++; changes.push({title,from,to,msg}); } };
  const capSentences = () => {
    s = s.replace(/(^|\.\s+|\?\s+|!\s+)([a-z])/g,(m,pre,ch)=>{
      const rep=pre+ch.toUpperCase(); if(rep!==m) add("Capitalization",m,rep,"Capitalize the start of a sentence."); return rep;
    });
  };

  // 0) 拼字（快速修正）
  s = s.replace(/\b([A-Za-z']+)\b/g,(m,w)=>{
    const low=w.toLowerCase(); const fix=SPELL[low]; if(fix){
      const rep = (w===w.toUpperCase())?fix.toUpperCase(): (w[0]===w[0].toUpperCase()?fix[0].toUpperCase()+fix.slice(1):fix);
      if(rep!==w) add("Spelling",w,rep,"Common misspelling."); return rep;
    }
    return w;
  });

  // 1) a/an
  s = s.replace(/\b(a)\s+([aeiouAEIOU])/g,(m,a,v)=>{const rep='an '+v; add("Article (a/an)",m,rep,"Use ‘an’ before a vowel sound."); return rep;});
  s = s.replace(/\b(an)\s+([^aeiouAEIOU\s])/g,(m,an,v)=>{const rep='a '+v; add("Article (a/an)",m,rep,"Use ‘a’ before a consonant sound."); return rep;});

  // 2) be 動詞一致
  s = s.replace(/\bI\s+are\b/gi, ()=>{add("Be-verb", "I are", "I am", "‘I’ takes ‘am’."); return "I am";});
  s = s.replace(/\bI\s+is\b/gi,  ()=>{add("Be-verb", "I is", "I am", "‘I’ takes ‘am’."); return "I am";});
  s = s.replace(/\b(you|we|they)\s+is\b/gi,(m,p)=>{const rep=p+" are"; add("Be-verb",m,rep,"Plural subjects take ‘are’."); return rep;});
  s = s.replace(/\b(he|she|it)\s+are\b/gi,(m,p)=>{const rep=p+" is"; add("Be-verb",m,rep,"he/she/it → is"); return rep;});

  // 3) have/has 一致
  s = s.replace(/\bI\s+has\b/gi, ()=>{add("Have/has","I has","I have","‘I’ takes ‘have’."); return "I have";});
  s = s.replace(/\b(you|we|they)\s+has\b/gi,(m,p)=>{const rep=p+" have"; add("Have/has",m,rep,"Plural subjects take ‘have’."); return rep;});
  s = s.replace(/\b(he|she|it)\s+have\b/gi,(m,p)=>{const rep=p+" has"; add("Have/has",m,rep,"he/she/it → has"); return rep;});

  // 4) 單數主語 + 複數表語 → 單數名詞（I/he/she/it am|is boys → a boy）
  const SING = {"boys":"boy","girls":"girl","students":"student","teachers":"teacher","friends":"friend",
                "cats":"cat","dogs":"dog","books":"book","apples":"apple","men":"man","women":"woman",
                "children":"child","people":"person"};
  s = s.replace(/\b(I|he|she|it)\s+(am|is)\s+([A-Za-z]+)\b/g,(m,subj,be,n)=>{
    const low=n.toLowerCase(); if(!SING[low]) return m;
    const word=SING[low]; const art=/^[aeiou]/i.test(word)?"an":"a";
    const rep=`${subj} ${be} ${art} ${word}`;
    add("Predicate number",m,rep,"Singular subject needs a singular complement."); return rep;
  });

  // 5) he/she/it 動詞三單 -s
  s = s.replace(/\b(he|she|it)\s+(go|do|have|say|play|watch|clean|study|try|fly|cry|walk|work|eat|come)\b/gi,(m,subj,verb)=>{
    const v=verb.toLowerCase(); let v3=v;
    if(v==='have') v3='has'; else if(v==='do') v3='does'; else if(v==='go') v3='goes';
    else if(/[^aeiou]y$/.test(v)) v3=v.slice(0,-1)+"ies";
    else if(/(sh|ch|x|s|o)$/.test(v)) v3=v+"es"; else v3=v+"s";
    const rep=`${subj} ${v3}`; if(rep!==m){ add("Agreement (3rd)",m,rep,"Add -s/-es in 3rd person."); } return rep;
  });
/* 5.24) go to shopping → go shopping（所有時態） */
s = s.replace(/\b(go|goes|went|gone|going)\s+to\s+shopping\b/gi, (m, v) => `${v} shopping`);

/* 5.24b) 英式 mum → 美式 mom；with mum → with my mom */
s = s.replace(/\bwith\s+(?:my\s+)?mum\b/gi, 'with my mom');
s = s.replace(/\bmum\b/gi, 'mom');

/* 5.24c) 句首未來時間 + 「go (to) shopping + 主語」→ 重排語序並補 will
   例：Tomorrow morning go to shopping I with mom → Tomorrow morning I will go shopping with my mom.
   說明：
   - 只在偵測到未來時間標記時啟動（未來式邏輯相容）
   - 捕捉「go (to) shopping + 主語」並把主語換到動詞前，再補 will
*/
(function () {
  const FUTURE_AHEAD = /\b(tomorrow|next\s+\w+|soon|in\s+\d+\s+(minutes?|hours?|days?|weeks?|months?|years?)|later|this\s+(afternoon|evening|weekend|week))\b/i;

  if (FUTURE_AHEAD.test(s)) {
    // go (to) shopping + I/you/he/she/we/they (+ 其後片語)
    s = s.replace(
      /\bgo(?:\s+to)?\s+shopping\s+(I|you|he|she|we|they)\b([^.!?]*)/gi,
      (m, subj, tail) => `${subj} will go shopping${tail}`
    );
    // 如果是 goes 也一併處理（主語會被換到前面，動詞改回 base 以搭配 will）
    s = s.replace(
      /\bgoes\s+(?:to\s+)?shopping\s+(he|she|it)\b([^.!?]*)/gi,
      (m, subj, tail) => `${subj} will go shopping${tail}`
    );
  }
})();
  // 6) 不定詞 / 情態：動詞原形（to slept → to sleep；can ate → can eat）
  (function(){
    const IRR_BASE={}; Object.keys(IRR).forEach(b=>{ const [v2,v3]=IRR[b]; IRR_BASE[v2]=b; IRR_BASE[(v3||v2)]=b; });
    const toBase = w=>{
      const lw=w.toLowerCase(); if(IRR_BASE[lw]) return IRR_BASE[lw];
      if(/[^aeiou]ied$/i.test(w)) return w.replace(/ied$/i,'y');
      if(/([bcdfghjklmnpqrstvwxyz])ed$/i.test(w)) return w.replace(/ed$/i,'');
      if(/([sxz]|sh|ch)es$/i.test(w)) return w.replace(/es$/i,'');
      if(/ies$/i.test(w)) return w.replace(/ies$/i,'y');
      if(/s$/i.test(w)) return w.replace(/s$/i,'');
      return w;
    };
    s = s.replace(/\bto\s+([a-z]+)\b/gi,(m,v)=>{ const base=toBase(v); const rep=`to ${base}`; if(rep!==m){ add("Infinitive base",m,rep,"Use base form after ‘to’."); } return rep; });
    s = s.replace(/\b(can|could|will|would|shall|should|may|might|must|let|did|does|do)\s+([a-z]+)\b/gi,(m,aux,v)=>{ const base=toBase(v); const rep=`${aux} ${base}`; if(rep!==m){ add("Modal base",m,rep,"Use base form after a modal/aux."); } return rep; });
  })();

  // 7) Present Perfect：規範 have/has + V3（美式 get→gotten），防呆 goned/goed
  (function(){
    // 先矯正明顯錯分詞
    const MIST = {"goed":"gone","goned":"gone","goted":"gotten","buyed":"bought","taked":"taken","eated":"eaten","comed":"come","runned":"run",
                  "thinked":"thought","bringed":"brought","sleeped":"slept","choosed":"chosen","writed":"written","sended":"sent","drived":"driven",
                  "forgived":"forgiven","forgeted":"forgotten"};
    s = s.replace(/\b(have|has)\s+([a-z]+)\b/gi,(m,aux,w)=>{
      const low=w.toLowerCase();
      if(MIST[low]){ const rep=`${aux} ${MIST[low]}`; add("Present perfect fix",m,rep,"Use correct past participle (V3)."); return rep; }
      // V2 → V3（have went → have gone）
      const baseByV2 = Object.fromEntries(Object.entries(IRR).map(([b,[v2]])=>[v2,b]));
      if(baseByV2[low]){ const b=baseByV2[low]; const v3=toPart(b); const rep=`${aux} ${v3}`; if(rep!==m){ add("Present perfect V2→V3",m,rep,"Use V3 after ‘have/has’."); } return rep; }
      // 若是原形（have go）→ have gone
      const bases=new Set(Object.keys(IRR));
      if(bases.has(low)){ const rep=`${aux} ${toPart(low)}`; if(rep!==m){ add("Present perfect base→V3",m,rep,"Use V3 after ‘have/has’."); } return rep; }
      return m;
    });
  })();

  // 8) Past tense：偵測過去時間標記 → 動詞用過去式
  const pastMark=/\b(yesterday|last\s+(night|week|month|year|mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)|\d+\s+(minute|hour|day|week|month|year)s?\s+ago|ago)\b/i;
  if(pastMark.test(s)){
    s = s.replace(/\b(I|you|we|they|he|she|it)\s+([a-z]+)\b/gi,(m,subj,verb)=>{
      const v=verb.toLowerCase();
      if(/^(am|is|are|was|were|been|be|have|has|had|do|does|did|will|can|should|would|might|must)$/.test(v)) return m;
      if(/(ed|t)$/.test(v) || Object.values(IRR).some(a=>a[0]===v)) return m;
      const rep=`${subj} ${toPast(v)}`; add("Past tense",m,rep,"Use past tense with past-time markers."); return rep;
    });
  }

  // 9) Future：偵測未來時間標記 → 沒有 will/going to 就補 will
  const futureMark=/\b(tomorrow|next\s+(week|month|year|mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)|soon|in\s+\d+\s+(minutes?|hours?|days?|weeks?|months?|years?))\b/i;
  if(futureMark.test(s) && !/\b(will|going to|be going to|plan to|intend to)\b/i.test(s)){
    s = s.replace(/\b(I|you|we|they|he|she|it)\s+([a-z]+)\b/gi,(m,subj,verb)=>{
      const v=verb.toLowerCase(); if(/^(am|is|are|was|were|been|be|have|has|had|do|does|did|can|should|would|might|must|will)$/.test(v)) return m;
      const rep = `${subj} will ${v}`; add("Future",m,rep,"Add ‘will’ for clear future time."); return rep;
    });
  }

  // 10) 常見介系詞修正
  [
    [/\bmarried with\b/gi,"married to","Use ‘to’ with ‘married’. "],
    [/\bdepend of\b/gi,"depend on","Use ‘on’ after ‘depend’. "],
    [/\binterested on\b/gi,"interested in","Use ‘in’ after ‘interested’. "],
    [/\bdifferent than\b/gi,"different from","Prefer ‘different from’. "],
    [/\barrive to\b/gi,"arrive at","Use ‘at’ with ‘arrive’. "],
    [/\barrive to home\b/gi,"arrive home","Drop the preposition with ‘home’. "],
    [/\bdiscuss about\b/gi,"discuss","‘Discuss’ doesn’t take ‘about’. "],
    [/\blisten (?!to)\b/gi,"listen to","Use ‘to’ after ‘listen’. "],
    [/\b(go|went|gone)\s+(school|work|class|church|library|park|store|market|hospital|office|airport|station|zoo|museum|cinema|theater|beach|farm)\b/gi,null,"Use ‘to’ with ‘go’ + place (except ‘home’)."]
  ].forEach(([re,to,why])=>{
    if(to){
      s = s.replace(re,(m)=>{ const rep=to; add("Preposition",m,rep,why); return rep; });
    }else{
      // go + place → go to place
      s = s.replace(re,(m,go,place)=>{ const rep=`${go} to ${place}`; add("Preposition",m,rep,why); return rep; });
    }
  });

  // 11) 句首大寫 & 空白清理
  capSentences();
  const before=s; s=s.replace(/ {2,}/g,' ').replace(/\s+([,.!?;:])/g,'$1');
  if(before!==s) add("Punctuation spacing","extra space","cleaned","Remove extra spaces.");
  return { text:s, count, changes };
}
/* 12) 單數主語 + 複數表語 → 單數名詞（更健壯版） */
(function () {
  // 單數化：先處理少量不規則，其次再處理規則變化
  const IRR_PL2SG = {
    men: "man", women: "woman", children: "child", people: "person",
    teeth: "tooth", feet: "foot", mice: "mouse", geese: "goose"
  };

  function singularize(word) {
    const low = word.toLowerCase();
    if (IRR_PL2SG[low]) return matchCase(IRR_PL2SG[low], word);
    if (/ies$/i.test(word)) return word.replace(/ies$/i, "y");            // babies → baby
    if (/(ses|xes|zes|ches|shes)$/i.test(word)) return word.replace(/es$/i, ""); // classes → class / boxes → box
    if (/s$/i.test(word) && !/ss$/i.test(word)) return word.replace(/s$/i, ""); // boys → boy；但保留 glass / boss
    return word; // 本來就單數就不動
  }
  function articleFor(w){ return /^[aeiou]/i.test(w) ? "an" : "a"; }

  // I/he/she/it + am/is + (可選多詞修飾) + 複數名詞
  s = s.replace(
    /\b(I|he|she|it)\s+(am|is)\s+((?:[a-z]+(?:\s+|$))*)?([a-z]+s)\b/gi,
    (m, subj, be, mods = "", plural) => {
      const modsTrim = (mods || "").trim();          // 例如 "very tall "
      const sing = singularize(plural);              // boys → boy / babies → baby…
      const needArticle = modsTrim ? "" : (articleFor(sing) + " "); // 有形容詞時常已含冠詞，不強塞
      const rep = `${subj} ${be} ${needArticle}${modsTrim ? modsTrim + " " : ""}${sing}`;
      add("Predicate number", m, rep, "Singular subject → singular complement.");
      return rep;
    }
  );
})();
  /* 11.9) 修正常見的「Tomorrow to school, I and Gigi」結構 */
s = s.replace(
  /\bTomorrow(?: morning| afternoon| evening)?\s+to\s+(school|work|class|church|library|park|store|market|hospital|office)\s*,?\s*i\s+and\s+([A-Z][a-z]+)\b/gi,
  (m, place, name) => {
    const rep = `I will go to ${place} with ${name} tomorrow`;
    add("Future sentence fix", m, rep, "Normalize future tense: subject + will go to + place + with + companion + tomorrow.");
    return rep;
  }
);
/* ————— LanguageTool pass + local pass ————— */
async function grammarPipeline(inputText){
  let text = inputText, ltChanges = [];
  // 1) LanguageTool（公共雲）
  try{
    const p = new URLSearchParams();
    p.append("text", text);
    p.append("language","en-US");
    p.append("enabledCategories","GRAMMAR,CONFUSED_WORDS,TYPOGRAPHY,PUNCTUATION,REDUNDANCY,STYLE");
    const r = await fetch("https://api.languagetool.org/v2/check",{
      method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body:p
    });
    if(r.ok){
      const j = await r.json();
      const matches=(j.matches||[]).filter(m=>m.replacements&&m.replacements[0]).sort((a,b)=>b.offset-a.offset);
      for(const m of matches){
        const from=text.slice(m.offset, m.offset+m.length);
        const to=m.replacements[0].value;
        text=text.slice(0,m.offset)+to+text.slice(m.offset+m.length);
        ltChanges.push({title:"LanguageTool",from,to,msg:m.message||""});
      }
    }
  }catch(_e){ /* 若 LT 暫時連不到，就只跑本地規則 */ }

  // 2) Local rules（補 LT 抓不到的：present perfect/過去&未來/介系詞/一致性等）
  const local = localFixOnce(text);

  return {
    text: local.text,
    total: ltChanges.length + local.count,
    ltCount: ltChanges.length,
    localCount: local.count,
    changes: [...ltChanges, ...local.changes]
  };
                                                                                                          }
/* ====== 共用 UI 工具 ====== */
const ui = {
  inputZh: document.getElementById('inputZh'),
  outputEn: document.getElementById('outputEn'),
  zh2en: document.getElementById('btnZhEn'),
  en2zh: document.getElementById('btnEnZh'),
  check: document.getElementById('btnCheck'),
  clearZh: document.getElementById('btnClearZh'),
  clearEn: document.getElementById('btnClearEn'),
  status: document.getElementById('status'),
  origHL: document.getElementById('origHL'),
  corrHL: document.getElementById('corrHL'),
  review: document.getElementById('review'),
  suggestList: document.getElementById('suggestList')
};
function setStatus(msg){ ui.status.textContent = msg; }
const esc = t => t.replace(/[&<>"']/g, c => ({'&':"&amp;",'<':"&lt;",'>':"&gt;",'"':"&quot;","'":"&#39;"}[c]));
function diffHL(oldText, newText){
  if(oldText === newText) return {origHL:esc(oldText), corrHL:esc(newText)};
  let s=0, eOld=oldText.length-1, eNew=newText.length-1;
  while(s<=eOld && s<=eNew && oldText[s]===newText[s]) s++;
  while(eOld>=s && eNew>=s && oldText[eOld]===newText[eNew]){ eOld--; eNew--; }
  return {
    origHL: esc(oldText.slice(0,s))+'<span class="hl-del">'+esc(oldText.slice(s,eOld+1))+'</span>'+esc(oldText.slice(eOld+1)),
    corrHL: esc(newText.slice(0,s))+'<span class="hl-ins">'+esc(newText.slice(s,eNew+1))+'</span>'+esc(newText.slice(eNew+1))
  };
}
function renderSuggestions(changes){
  ui.suggestList.innerHTML="";
  changes.forEach(ch=>{
    const li=document.createElement('li');
    li.innerHTML = `<strong>${esc(ch.title)}</strong>： ${esc(ch.msg||"")}<br>
      <span class="chip-old">${esc(ch.from)}</span> → <span class="chip-new">${esc(ch.to)}</span>`;
    ui.suggestList.appendChild(li);
  });
}

/* ====== 翻譯：MyMemory + LibreTranslate 備援 ====== */
const LT_NODES = [
  "https://libretranslate.de",
  "https://translate.argosopentech.com",
  "https://translate.mentality.rip"
];
async function fetchWithTimeout(url, options={}, timeoutMs=9000){
  const ctrl = new AbortController(); const t=setTimeout(()=>ctrl.abort(), timeoutMs);
  try{ const r=await fetch(url, {...options, signal:ctrl.signal}); clearTimeout(t); return r; }
  catch(e){ clearTimeout(t); throw e; }
}
async function translateViaMyMemory(text, dir){
  const source=(dir==="zh-en")?"zh-CN":"en";
  const target=(dir==="zh-en")?"en":"zh-TW";
  const r=await fetchWithTimeout(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${source}|${target}`);
  if(!r.ok) throw new Error("MyMemory "+r.status);
  const j=await r.json();
  return j?.responseData?.translatedText || "";
}
async function translateViaLibre(base, text, dir){
  const target=(dir==="zh-en")?"en":"zh-TW";
  const r=await fetchWithTimeout(`${base}/translate`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({ q:text, source:"auto", target, format:"text" })
  });
  if(!r.ok) throw new Error("Libre "+r.status);
  const j=await r.json(); return j?.translatedText || "";
}
async function translateSmart(text, dir){
  if(!text || !text.trim()) return "";
  try{
    const mm=await translateViaMyMemory(text, dir);
    if(mm && mm.trim()) return mm;
  }catch(_e){}
  for(const n of LT_NODES){
    try{
      const x=await translateViaLibre(n, text, dir);
      if(x && x.trim()) return x;
    }catch(_e){}
  }
  // 若全部失敗，原文回填
  setStatus("⚠️ 翻譯服務暫時無法連線，已顯示原文。");
  return text;
}

/* ====== LanguageTool：智慧修正 ====== */
async function grammarPipeline(text){
  try{
    const p=new URLSearchParams();
    p.append("text", text);
    p.append("language","en-US");
    const r=await fetch("https://api.languagetool.org/v2/check",{
      method:"POST",
      headers:{"Content-Type":"application/x-www-form-urlencoded"},
      body:p
    });
    if(!r.ok) throw new Error("HTTP "+r.status);
    const j=await r.json();
    const ms=(j.matches||[]).filter(m=>m.replacements&&m.replacements[0]).sort((a,b)=>b.offset-a.offset);
    let out=text, changes=[];
    for(const m of ms){
      const from=out.slice(m.offset, m.offset+m.length);
      const to=m.replacements[0].value;
      out=out.slice(0,m.offset)+to+out.slice(m.offset+m.length);
      changes.push({ title:"LanguageTool", from, to, msg:m.message||"" });
    }
    return { text:out, count:changes.length, changes };
  }catch(e){
    setStatus("❌ Grammar check 失敗：" + e.message);
    return { text, count:0, changes:[] };
  }
}

/* ====== 事件綁定 ====== */
ui.zh2en.addEventListener('click', async()=>{
  const txt=ui.inputZh.value.trim(); if(!txt){ return; }
  setStatus("翻譯中（中 ➜ 英）…");
  ui.outputEn.value = await translateSmart(txt,"zh-en");
  setStatus("✅ 完成：中文 ➜ 英文");
});

ui.en2zh.addEventListener('click', async()=>{
  const txt=ui.outputEn.value.trim(); if(!txt){ return; }
  setStatus("翻譯中（英 ➜ 中）…");
  ui.outputEn.value = await translateSmart(txt,"en-zh");
  setStatus("✅ 完成：英文 ➜ 中文(繁體)");
});

ui.check.addEventListener('click', async()=>{
  const before = ui.outputEn.value.trim(); if(!before){ return; }
  setStatus("Grammar 檢查中…");
  const res = await grammarPipeline(before);
  ui.outputEn.value = res.text;

  const d = diffHL(before, res.text);
  if(res.text !== before){
    ui.origHL.innerHTML = d.origHL;
    ui.corrHL.innerHTML = d.corrHL;
    ui.review.style.display = "block";
  }else{
    ui.review.style.display = "none";
  }
  renderSuggestions(res.changes);
  setStatus(`✅ 已完成智慧修正（修正 ${res.count} 處）`);
});

ui.clearZh.addEventListener('click',()=>ui.inputZh.value="");
ui.clearEn.addEventListener('click',()=>ui.outputEn.value="");
</script>
</body>
</html>
