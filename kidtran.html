<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Miss K Englishclass</title>
<style>
:root{
  --kids-bg:#FFF7CC; --kids-panel:#FFE680; --kids-panel-2:#FFEF99;
  --kids-accent:#FFB703; --kids-accent-2:#FB8500; --kids-text:#3A2D00;
  --kids-muted:#6B5600; --kids-border:#FFD259; --kids-shadow:0 6px 18px rgba(160,120,0,.18);
  --kids-radius:12px;
}
body{
  background:var(--kids-bg)!important; color:var(--kids-text)!important;
  font-family:"Comic Sans MS","Noto Sans TC","Microsoft JhengHei",system-ui,Arial,sans-serif!important;
  line-height:1.6; padding-bottom:90px;
}
header{ background:linear-gradient(180deg,var(--kids-panel),var(--kids-panel-2))!important;
  border-bottom:2px dashed var(--kids-border)!important; box-shadow:var(--kids-shadow)!important;
  padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
h1{ color:var(--kids-text)!important; font-size:18px; margin:0; } h1::before{ content:"ğŸ¦"; margin-right:6px; }
.btn{ padding:10px 14px!important; border:2px solid var(--kids-border)!important; border-radius:20px!important;
  background:#fff8d9!important; color:var(--kids-text)!important; box-shadow:var(--kids-shadow)!important; font-weight:700!important; }
.btn.primary{ background:var(--kids-accent)!important; border-color:var(--kids-accent-2)!important; color:#1b1100!important; }
textarea{ width:100%; height:220px; border-radius:14px!important; border:2px solid var(--kids-border)!important;
  background:#fffef5!important; color:var(--kids-text)!important; font-size:15px!important; padding:10px; }
#status{ border:2px dashed var(--kids-border)!important; border-radius:var(--kids-radius)!important;
  background:#fff7d1!important; color:var(--kids-text)!important; box-shadow:var(--kids-shadow)!important; padding:12px; margin:18px; }
.grid{ display:grid; gap:14px; margin:18px; }
@media (min-width:800px){ .grid{ grid-template-columns:1fr 1fr; } }
.panel{ background:#fffbea; border:2px solid var(--kids-border); border-radius:var(--kids-radius); padding:14px; box-shadow:var(--kids-shadow); }
label{ display:block; margin-bottom:8px; font-weight:900; color:var(--kids-muted); }
/* é«˜äº® */
.hl-del{ background:#ffe3e3; text-decoration:line-through; border-radius:4px; padding:0 2px; }
.hl-ins{ background:#ddf8dd; border-bottom:2px solid #2d8a2d; border-radius:4px; padding:0 2px; }
.small{ font-size:13px; color:#5f4b00; }
#review{ display:none; margin:18px; }
/* è²¼ç´™ï¼šä¸æ“‹å­—ã€ä¸æ””æˆªé»æ“Š */
body::after{
  content:" ğŸ»ğŸ°ğŸ¦Š ä¸€èµ·å­¸English ï¼ ";
  position:fixed; right:10px; bottom:6px;
  background:#fff; border:2px solid var(--kids-border); border-radius:14px;
  padding:8px 10px; box-shadow:var(--kids-shadow); font-weight:800; color:var(--kids-text);
  transform:scale(.9); pointer-events:none;
}
@media (max-width:480px){
  body{ padding-bottom:110px; }
  body::after{ bottom:2px; right:6px; transform:scale(.85); }
}
</style>
</head>
<body>
<header>
  <h1>Miss K English class</h1>
  
</header>

<div class="grid">
  <div class="panel">
    <label>ä¸­æ–‡</label>
    <textarea id="inputZh" placeholder="è¼¸å…¥ä¸­æ–‡"></textarea>
    <div class="row">
      <button id="btnZhEn" class="btn primary">ä¸­æ–‡ âœ è‹±æ–‡</button>
      <button id="btnClearZh" class="btn">æ¸…ç©º</button>
    </div>
  </div>

  <div class="panel">
    <label>English</label>
    <textarea id="outputEn" placeholder="ç¿»è­¯çµæœ"></textarea>
    <div class="row">
      <button id="btnEnZh" class="btn primary">è‹±æ–‡ âœ ä¸­æ–‡</button>
      <button id="btnCheck" class="btn">Grammar</button>
      <button id="btnClearEn" class="btn">æ¸…ç©º</button>
    </div>
  </div>
</div>

<div id="status">âœ¨ ç›´æ¥è¼¸å…¥ä¸­æ–‡æˆ–è‹±æ–‡å³å¯ã€‚</div>

<div id="review" class="panel">
  <strong>ğŸ›  ä¿®æ­£ç´°ç¯€</strong>
  <p class="small">ç´…è‰²åˆªé™¤ï¼Œç¶ è‰²æ–°å¢ã€‚</p>
  <div><strong>åŸå¥ï¼š</strong> <span id="origHL"></span></div>
  <div><strong>ä¿®æ­£æ–‡ï¼š</strong> <span id="corrHL"></span></div>
</div>

<script>
(function(){
  const ui = {
    inputZh: document.getElementById('inputZh'),
    outputEn: document.getElementById('outputEn'),
    zh2en: document.getElementById('btnZhEn'),
    en2zh: document.getElementById('btnEnZh'),
    check: document.getElementById('btnCheck'),
    clearZh: document.getElementById('btnClearZh'),
    clearEn: document.getElementById('btnClearEn'),
    status: document.getElementById('status'),
    save: document.getElementById('btnSave'),
    diag: document.getElementById('btnDiag'),
    origHL: document.getElementById('origHL'),
    corrHL: document.getElementById('corrHL'),
    review: document.getElementById('review')
  };
  function setStatus(msg){ ui.status.textContent = msg; }
  function escapeHTML(s){ return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

  async function libreTranslate(text, target){
    const res = await fetch("https://libretranslate.de/translate", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ q:text, source:"auto", target:target, format:"text" })
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();
    return data.translatedText;
  }
  async function myMemory(text, source, target){
    const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${source}|${target}`;
    const r=await fetch(url); const j=await r.json();
    return j?.responseData?.translatedText || "";
  }
  async function translateSmart(text, dir){
    try{
      return await libreTranslate(text, dir==="zh-en"?"en":"zh-TW");
    }catch(e){
      setStatus("âš ï¸ é‡æ–°æª¢æŸ¥ã€‚");
      return await myMemory(text, dir==="zh-en"?"zh-CN":"en", dir==="zh-en"?"en":"zh-TW");
    }
  }

  // ======= Grammar Proï¼šå¤šè¼ªï¼ˆAPI + æœ¬åœ°è¦å‰‡ï¼‰ =======
  const MAX_PASSES = 3;

  // ä¸è¦å‰‡å‹•è©ï¼šV2(éå»å¼)ã€V3(éå»åˆ†è©)
  const IRR = {
    "am":["was","been"], "is":["was","been"], "are":["were","been"],
    "do":["did","done"], "does":["did","done"], "go":["went","gone"],
    "come":["came","come"], "eat":["ate","eaten"], "see":["saw","seen"],
    "take":["took","taken"], "make":["made","made"], "have":["had","had"], "has":["had","had"],
    "get":["got","gotten"], "give":["gave","given"], "write":["wrote","written"],
    "read":["read","read"], "run":["ran","run"], "sleep":["slept","slept"],
    "feel":["felt","felt"], "leave":["left","left"], "meet":["met","met"],
    "pay":["paid","paid"], "put":["put","put"], "say":["said","said"],
    "buy":["bought","bought"], "bring":["brought","brought"], "think":["thought","thought"],
    "teach":["taught","taught"], "begin":["began","begun"], "become":["became","become"],
    "find":["found","found"], "hold":["held","held"], "keep":["kept","kept"],
    "speak":["spoke","spoken"], "drink":["drank","drunk"], "drive":["drove","driven"],
    "forget":["forgot","forgotten"], "forgive":["forgave","forgiven"], "grow":["grew","grown"],
    "know":["knew","known"], "lose":["lost","lost"], "meet":["met","met"],
    "send":["sent","sent"], "sit":["sat","sat"], "stand":["stood","stood"],
    "understand":["understood","understood"], "win":["won","won"]
  };
  function toPast(v){ if(IRR[v]) return IRR[v][0];
    if(/[^aeiou]y$/.test(v)) return v.slice(0,-1)+"ied";
    if(v.endsWith("e")) return v+"d";
    return v+"ed"; }
  function toPart(v){ if(IRR[v]) return IRR[v][1] || IRR[v][0];
    if(/[^aeiou]y$/.test(v)) return v.slice(0,-1)+"ied";
    if(v.endsWith("e")) return v+"d";
    return v+"ed"; }

  // æ‹¼å­—å¸¸è¦‹éŒ¯èª¤ï¼ˆç°¡æ˜“ï¼‰
  const SPELL = {
    "becuase":"because","recieve":"receive","seperate":"separate","definately":"definitely",
    "wierd":"weird","adress":"address","enviroment":"environment","tomatos":"tomatoes",
    "alot":"a lot","occured":"occurred","wich":"which","thier":"their","beleive":"believe",
    "freind":"friend","studing":"studying","untill":"until"
  };

  async function applyLanguageToolOnce(input){
    try{
      const p=new URLSearchParams();
      p.append("text", input);
      p.append("language","en-US");
      p.append("enabledCategories","GRAMMAR,CONFUSED_WORDS,TYPOGRAPHY,PUNCTUATION,REDUNDANCY,STYLE");
      p.append("preferredVariants","en-US"); // æ‹¼å­—èµ°ç¾å¼
      const r=await fetch("https://api.languagetool.org/v2/check", {
        method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body:p
      });
      if(!r.ok) throw new Error("HTTP "+r.status);
      const j=await r.json();
      const ms=(j.matches||[]).filter(m=>m.replacements&&m.replacements[0]).sort((a,b)=>b.offset-a.offset);
      let out=input, cnt=0;
      for(const m of ms){
        const rep=m.replacements[0].value;
        out = out.slice(0,m.offset)+rep+out.slice(m.offset+m.length);
        cnt++;
      }
      return { text:out, count:cnt };
    }catch(e){ return { text:input, count:0 }; }
  }

  // === æœ¬åœ°ä¸€æ¬¡æ€§ä¿®æ­£ï¼šæ‹¼å­—/ä¸»è¬‚/å† è©/æ‰€æœ‰æ ¼/å‰¯è©åŒ–/ä»‹ç³»è©/æ™‚æ…‹ï¼ˆéå»å¼ãƒ»ç¾åœ¨å®Œæˆå¼ãƒ»æœªä¾†å¼ï¼‰ ===
  function localFixOnce(src){
    let s=src, c=0;

    // 0) æ‹¼å­—
    s = s.replace(/\b([A-Za-z']+)\b/g,(m,w)=>{
      const low=w.toLowerCase();
      if(SPELL[low]){ c++; return matchCase(SPELL[low],w); }
      return w;
    });

    // 1) æ‰€æœ‰æ ¼ï¼šhim/her/them + noun
    s = s.replace(/\b(him|her|them)\s+([A-Za-z]+)\b/g,(m,p1,p2)=>{ c++; return (p1==='him'?'his':p1==='her'?'her':'their')+' '+p2; });

    // 2) ä¸å®šå† è© a/an
    s = s.replace(/\b(a)\s+([aeiouAEIOU])/g,(m,a,v)=>{ c++; return 'an '+v; });
    s = s.replace(/\b(an)\s+([^aeiouAEIOU\s])/g,(m,an,cons)=>{ c++; return 'a '+cons; });

    // 3) ä¸»è¬‚ä¸€è‡´ï¼ˆç¾åœ¨ç°¡å–®å¼ï¼‰
    s = s.replace(/\b(he|she|it)\s+(go|do|have|has|say|play|watch|clean|study|try|fly|cry|walk|work|eat|come)\b/gi,
      (m,subj,verb)=>{
        const v=verb.toLowerCase();
        if(v==='have'||v==='has') return `${subj} has`;
        if(v==='do') return `${subj} does`;
        if(v==='go') return `${subj} goes`;
        if(/(y)$/.test(v) && !/[aeiou]y$/.test(v)) return `${subj} ${v.slice(0,-1)}ies`;
        if(v.endsWith('sh')||v.endsWith('ch')||v.endsWith('x')||v.endsWith('s')||v.endsWith('o')) return `${subj} ${v}es`;
        return `${subj} ${v}s`;
      });

    // 4) é›™é‡å¦å®š â†’ any
    s = s.replace(/\b(don't|do not|doesn't|does not|didn't|did not)\s+([a-z]+)\s+no\b/gi,(m,aux,verb)=>{ c++; return `${aux} ${verb} any`; });

    // 5) å½¢å®¹è©â†’å‰¯è©ï¼ˆå‹•è©å¾Œæ¥å½¢å®¹è©ï¼Œå¦‚ drive careful â†’ drive carefullyï¼›ä¾‹å¤– goodâ†’well, fast/late/hard ä¸è®Šï¼‰
    s = s.replace(/\b(\w+)\s+(careful|quiet|happy|loud|slow|quick|bad|good)\b/gi,(m,verb,adj)=>{
      const a=adj.toLowerCase();
      if(a==='good') { c++; return `${verb} well`; }
      if(a==='bad')  { c++; return `${verb} badly`; }
      if(a==='fast' || a==='hard' || a==='late') return m;
      c++; return `${verb} ${a}ly`;
    });

    // 6) å¸¸è¦‹ä»‹ç³»è©æ­é…
    const PREP = [
      [/\bmarried with\b/gi,'married to'],
      [/\bdepend of\b/gi,'depend on'],
      [/\binterested on\b/gi,'interested in'],
      [/\bdifferent than\b/gi,'different from'],
      [/\barrive to\b/gi,'arrive at'],
      [/\barrive to home\b/gi,'arrive home'],
      [/\bdiscuss about\b/gi,'discuss'],
      [/\blisten (?!to)\b/gi,'listen to'],
      [/\bin Monday\b/gi,'on Monday'],
      [/\bin Tuesday\b/gi,'on Tuesday'],
      [/\bin Wednesday\b/gi,'on Wednesday'],
      [/\bin Thursday\b/gi,'on Thursday'],
      [/\bin Friday\b/gi,'on Friday'],
      [/\bin Saturday\b/gi,'on Saturday'],
      [/\bin Sunday\b/gi,'on Sunday'],
      [/\bin the morning\b/gi,'in the morning'],
      [/\bin the afternoon\b/gi,'in the afternoon'],
      [/\bat night\b/gi,'at night']
    ];
    PREP.forEach(([re,rep])=>{ s = s.replace(re,()=>{ c++; return rep; }); });

    // 7) éå»æ™‚é–“æ¨™è¨˜ â†’ ä¸€èˆ¬éå»å¼
    const pastMark = /\b(yesterday|last\s+(night|week|month|year|mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)|\d+\s+(minute|hour|day|week|month|year)s?\s+ago|ago)\b/i;
    if(pastMark.test(s)){
      s = s.replace(/\b(I|he|she|we|they|you)\s+(?:do not|don't|does not|doesn't)?\s*([a-z]+)\b/gi,
        (m,subj,verb)=>{
          const v=verb.toLowerCase();
          if(/\b(was|were|did|had|went|came|saw|ate|took|made|got|ran|slept|felt|left|met|paid|put|said)\b/i.test(v)) return m;
          c++; return `${subj} ${toPast(v)}`;
        });
    }

    // 8) ç¾åœ¨å®Œæˆå¼è§¸ç™¼è© â†’ have/has + V3
    const perfMark = /\b(already|yet|ever|never|just|recently|lately|since|for\s+\d+|so far|in the last|in recent (days|weeks|months|years))\b/i;
    if(perfMark.test(s)){
      s = s.replace(/\b(I|we|they|you)\s+(?:did|do|does)?\s*([a-z]+)\b/gi,(m,subj,verb)=>{
        const v=verb.toLowerCase(); c++; return `${subj} have ${toPart(v)}`;
      });
      s = s.replace(/\b(he|she|it)\s+(?:did|do|does)?\s*([a-z]+)\b/gi,(m,subj,verb)=>{
        const v=verb.toLowerCase(); c++; return `${subj} has ${toPart(v)}`;
      });
      // ä¿®æ­£ have + V2 â†’ have + V3ï¼ˆä¾‹å¦‚ have ate â†’ have eatenï¼‰
      s = s.replace(/\b(have|has)\s+([a-z]+)\b/gi,(m,aux,verb)=>{
        const v=verb.toLowerCase(); const v3=toPart(v);
        if(v3!==verb){ c++; return `${aux} ${v3}`; }
        return m;
      });
    }

    // 9) æœªä¾†æ™‚é–“æ¨™è¨˜ â†’ will + åŸå½¢ï¼ˆè‹¥å°šæœªåŒ…å« will/going toï¼‰
    const futureMark = /\b(tomorrow|next\s+(week|month|year|mon(day)?|tue(sday)?|wed(nesday)?|thu(rsday)?|fri(day)?|sat(urday)?|sun(day)?)|soon|in\s+\d+\s+(minutes?|hours?|days?|weeks?|months?|years?))\b/i;
    if(futureMark.test(s) && !/\b(will|going to|be going to|plan to|intend to)\b/i.test(s)){
      s = s.replace(/\b(I|he|she|it|we|they|you)\s+([a-z]+)\b/gi,(m,subj,verb)=>{
        const v=verb.toLowerCase();
        // é¿å…æ”¹åˆ° be/aux
        if(/^(am|is|are|was|were|been|be|have|has|had|do|does|did|will)$/i.test(v)) return m;
        c++; return `${subj} will ${v}`;
      });
    }

    // 10) ç¬¦è™Ÿèˆ‡ç©ºç™½
    s = s.replace(/ {2,}/g,' '); // å¤šé‡ç©ºç™½
    s = s.replace(/\s+([,.!?;:])/g,'$1'); // æ¨™é»å‰ç©ºç™½
    s = s.replace(/(^|[.!?]\s+)([a-z])/g,(m,pre,ch)=>pre+ch.toUpperCase()); // å¥é¦–å¤§å¯«

    return { text:s, count:c };
  }

  // å¤šè¼ªç®¡ç·š
  async function grammarPipeline(text){
    let cur=text, total=0, passes=0;
    for(passes=1; passes<=MAX_PASSES; passes++){
      const before=cur;
      const apiRes = await applyLanguageToolOnce(cur);
      const localRes = localFixOnce(apiRes.text);
      cur = localRes.text;
      total += apiRes.count + localRes.count;
      if(cur===before) break;
    }
    return { text:cur, total, passes };
  }

  // é«˜äº®å·®ç•°
  function diffHL(oldText, newText){
    if(oldText===newText) return { origHL:escapeHTML(oldText), corrHL:escapeHTML(newText) };
    let s=0, eOld=oldText.length-1, eNew=newText.length-1;
    while(s<=eOld && s<=eNew && oldText[s]===newText[s]) s++;
    while(eOld>=s && eNew>=s && oldText[eOld]===newText[eNew]){ eOld--; eNew--; }
    return {
      origHL: escapeHTML(oldText.slice(0,s))+
              `<span class="hl-del">${escapeHTML(oldText.slice(s,eOld+1))}</span>`+
              escapeHTML(oldText.slice(eOld+1)),
      corrHL: escapeHTML(newText.slice(0,s))+
              `<span class="hl-ins">${escapeHTML(newText.slice(s,eNew+1))}</span>`+
              escapeHTML(newText.slice(eNew+1))
    };
  }

  function matchCase(target, sample){
    if(sample===sample.toUpperCase()) return target.toUpperCase();
    if(sample[0]===sample[0].toUpperCase()) return target[0].toUpperCase()+target.slice(1);
    return target;
  }

  // === UI ===
  ui.zh2en.addEventListener('click', async()=>{
    const txt=ui.inputZh.value.trim(); if(!txt) return;
    setStatus("ç¿»è­¯ä¸­ï¼ˆä¸­â†’è‹±ï¼‰â€¦");
    ui.outputEn.value=await translateSmart(txt,"zh-en");
    setStatus("âœ… å®Œæˆï¼šä¸­æ–‡â†’è‹±æ–‡");
  });
  ui.en2zh.addEventListener('click', async()=>{
    const txt=ui.outputEn.value.trim(); if(!txt) return;
    setStatus("ç¿»è­¯ä¸­ï¼ˆè‹±â†’ç¹é«”ä¸­æ–‡ï¼‰â€¦");
    ui.outputEn.value=await translateSmart(txt,"en-zh");
    setStatus("âœ… å®Œæˆï¼šè‹±æ–‡â†’ä¸­æ–‡(ç¹é«”)");
  });
  ui.check.addEventListener('click', async()=>{
    const txt=ui.outputEn.value.trim(); if(!txt) return;
    setStatus("Grammar æª¢æŸ¥ä¸­â€¦");
    const res = await grammarPipeline(txt);
    ui.outputEn.value = res.text;
    const d = diffHL(txt, res.text);
    if(res.text!==txt){
      ui.origHL.innerHTML = d.origHL;
      ui.corrHL.innerHTML = d.corrHL;
      ui.review.style.display = "block";
    }else{
      ui.review.style.display = "none";
    }
    setStatus(`âœ… å®Œæˆï¼šGrammarï¼ˆå…± ${res.total} é …ä¿®æ­£ï¼ŒåŸ·è¡Œ ${res.passes} æ¬¡ï¼‰`);
  });
  ui.clearZh.addEventListener('click',()=>ui.inputZh.value="");
  ui.clearEn.addEventListener('click',()=>ui.outputEn.value="");
  ui.save.addEventListener('click',()=>{
    const blob=new Blob([document.documentElement.outerHTML],{type:"text/html;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="tran-kids-grammar-pro.html"; a.click();
    URL.revokeObjectURL(url);
  });
  ui.diag.addEventListener('click', async()=>{
    try{
      const r=await fetch("https://libretranslate.de/");
      setStatus("è¨ºæ–·ï¼šLibreTranslate "+(r.ok?"å¯ç”¨":"å¤±æ•—")+" | HTTP "+r.status);
    }catch(e){ setStatus("è¨ºæ–·ï¼šè«‹æ±‚å¤±æ•—"); }
  });
})();
</script>
</body>
</html>
