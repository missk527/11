<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Miss K English class</title>
<style>
:root{
  --kids-bg:#FFF7CC; --kids-panel:#FFE680; --kids-panel-2:#FFEF99;
  --kids-accent:#FFB703; --kids-accent-2:#FB8500; --kids-text:#3A2D00;
  --kids-muted:#6B5600; --kids-border:#FFD259; --kids-shadow:0 6px 18px rgba(160,120,0,.18);
  --kids-radius:12px;
}
body{
  background:var(--kids-bg); color:var(--kids-text);
  font-family:"Comic Sans MS","Noto Sans TC","Microsoft JhengHei",system-ui,Arial,sans-serif;
  line-height:1.6; padding-bottom:90px;
}
header{ background:linear-gradient(180deg,var(--kids-panel),var(--kids-panel-2));
  border-bottom:2px dashed var(--kids-border); box-shadow:var(--kids-shadow);
  padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
h1{ color:var(--kids-text); font-size:18px; margin:0; } h1::before{ content:"ğŸ¦"; margin-right:6px; }
.btn{ padding:10px 14px; border:2px solid var(--kids-border); border-radius:20px;
  background:#fff8d9; color:var(--kids-text); box-shadow:var(--kids-shadow); font-weight:700; }
.btn.primary{ background:var(--kids-accent); border-color:var(--kids-accent-2); color:#1b1100; }
textarea{ width:100%; height:220px; border-radius:14px; border:2px solid var(--kids-border);
  background:#fffef5; color:var(--kids-text); font-size:15px; padding:10px; }
#status{ border:2px dashed var(--kids-border); border-radius:var(--kids-radius);
  background:#fff7d1; color:var(--kids-text); box-shadow:var(--kids-shadow); padding:12px; margin:18px; }
.grid{ display:grid; gap:14px; margin:18px; } @media (min-width:800px){ .grid{ grid-template-columns:1fr 1fr; } }
.panel{ background:#fffbea; border:2px solid var(--kids-border); border-radius:var(--kids-radius);
  padding:14px; box-shadow:var(--kids-shadow); }
label{ display:block; margin-bottom:8px; font-weight:900; color:var(--kids-muted); }

/* é«˜äº®å·®ç•° */
.hl-del{ background:#ffe3e3; text-decoration:line-through; border-radius:4px; padding:0 2px; }
.hl-ins{ background:#ddf8dd; border-bottom:2px solid #2d8a2d; border-radius:4px; padding:0 2px; }
.small{ font-size:13px; color:#5f4b00; }
#review{ display:none; margin:18px; }

/* å³ä¸‹è²¼ç´™ */
body::after{
  content:" ğŸ»ğŸ°ğŸ¦Š ä¸€èµ·å­¸Englishï¼ ";
  position:fixed; right:10px; bottom:6px;
  background:#fff; border:2px solid var(--kids-border); border-radius:14px;
  padding:8px 10px; box-shadow:var(--kids-shadow);
  font-weight:800; color:var(--kids-text);
  transform:scale(.9); pointer-events:none;
}
@media (max-width:480px){
  body{ padding-bottom:110px; }
  body::after{ bottom:2px; right:6px; transform:scale(.85); }
}
</style>
</head>
<body>
<header>
  <h1>Miss K English class</h1>
  
</header>

<div class="grid">
  <div class="panel">
    <label>ä¸­æ–‡</label>
    <textarea id="inputZh" placeholder="è¼¸å…¥ä¸­æ–‡"></textarea>
    <div class="row" style="margin-top:8px; display:flex; gap:10px;">
      <button id="btnZhEn" class="btn primary">ä¸­æ–‡ âœ è‹±æ–‡</button>
      <button id="btnClearZh" class="btn">æ¸…ç©º</button>
    </div>
  </div>

  <div class="panel">
    <label>English</label>
    <textarea id="outputEn" placeholder="ç¿»è­¯çµæœ"></textarea>
    <div class="row" style="margin-top:8px; display:flex; gap:10px;">
      <button id="btnEnZh" class="btn primary">è‹±æ–‡ âœ ä¸­æ–‡</button>
      <button id="btnCheck" class="btn">Grammar</button>
      <button id="btnClearEn" class="btn">æ¸…ç©º</button>
    </div>
  </div>
</div>

<div id="status">âœ¨ ç›´æ¥è¼¸å…¥ä¸­æ–‡æˆ–è‹±æ–‡å³å¯ã€‚</div>

<div id="review" class="panel">
  <strong>ğŸ›  ä¿®æ­£ç´°ç¯€</strong>
  <p class="small">ç´…è‰²åˆªé™¤ï¼Œç¶ è‰²æ–°å¢ã€‚</p>
  <div><strong>åŸå¥ï¼š</strong> <span id="origHL"></span></div>
  <div><strong>ä¿®æ­£æ–‡ï¼š</strong> <span id="corrHL"></span></div>
</div>

<script>
(function(){
  const ui = {
    inputZh: document.getElementById('inputZh'),
    outputEn: document.getElementById('outputEn'),
    zh2en: document.getElementById('btnZhEn'),
    en2zh: document.getElementById('btnEnZh'),
    check: document.getElementById('btnCheck'),
    clearZh: document.getElementById('btnClearZh'),
    clearEn: document.getElementById('btnClearEn'),
    status: document.getElementById('status'),
    save: document.getElementById('btnSave'),
    diag: document.getElementById('btnDiag'),
    origHL: document.getElementById('origHL'),
    corrHL: document.getElementById('corrHL'),
    review: document.getElementById('review')
  };
  function setStatus(msg){ ui.status.textContent = msg; }
  function escapeHTML(s){ return s.replace(/[&<>"']/g,c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }
  function matchCase(target, sample){
    if(sample===sample.toUpperCase()) return target.toUpperCase();
    if(sample[0]===sample[0].toUpperCase()) return target[0].toUpperCase()+target.slice(1);
    return target;
  }

  // ç¿»è­¯ï¼ˆMyMemory + å¤šç¯€é» LTï¼‰
  const LT_NODES = ["https://libretranslate.de","https://translate.argosopentech.com","https://translate.mentality.rip"];
  async function fetchWithTimeout(url, options={}, timeoutMs=8000){
    const ctrl=new AbortController(); const t=setTimeout(()=>ctrl.abort(),timeoutMs);
    try{ const r=await fetch(url,{...options,signal:ctrl.signal}); clearTimeout(t); return r; }catch(e){ clearTimeout(t); throw e; }
  }
  async function translateViaMyMemory(text,dir){
    const source=(dir==="zh-en")?"zh-CN":"en"; const target=(dir==="zh-en")?"en":"zh-TW";
    const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${source}|${target}`;
    const r=await fetchWithTimeout(url,{},8000); if(!r.ok) throw new Error("MM HTTP "+r.status);
    const j=await r.json(); return j?.responseData?.translatedText||"";
  }
  async function translateViaLibre(nodeBase,text,dir){
    const target=(dir==="zh-en")?"en":"zh-TW";
    const url=`${nodeBase}/translate`; const body=JSON.stringify({q:text,source:"auto",target,format:"text"});
    const r=await fetchWithTimeout(url,{method:"POST",headers:{"Content-Type":"application/json"},body},8000);
    if(!r.ok) throw new Error("LT HTTP "+r.status); const j=await r.json(); return j?.translatedText||"";
  }
  async function translateSmart(text,dir){
    if(!text||!text.trim()) return "";
    try{ const mm=await translateViaMyMemory(text,dir); if(mm&&mm.trim()) return mm; }catch(_e){}
    for(const node of LT_NODES){ try{ const lt=await translateViaLibre(node,text,dir); if(lt&&lt.trim()) return lt; }catch(_e){} }
    setStatus("âš ï¸ ç¿»è­¯æœå‹™æš«æ™‚é€£ä¸ä¸Šï¼ˆå·²é¡¯ç¤ºåŸæ–‡ï¼‰ã€‚"); return text;
  }

  // Grammarï¼šlocalFixOnce è£œå¼·
  function localFixOnce(src){
    let s=src,c=0;

    // A) Be å‹•è©ä¸€è‡´
    s = s.replace(/\bI\s+are\b/gi,()=>{c++;return "I am";});
    s = s.replace(/\bI\s+is\b/gi,()=>{c++;return "I am";});
    s = s.replace(/\byou\s+is\b/gi,()=>{c++;return "you are";});
    s = s.replace(/\bwe\s+is\b/gi,()=>{c++;return "we are";});
    s = s.replace(/\bthey\s+is\b/gi,()=>{c++;return "they are";});
    s = s.replace(/\b(he|she|it)\s+are\b/gi,(m,subj)=>{c++;return `${subj} is`;});

    // B) å–®æ•¸ä¸»èª + è¤‡æ•¸åè©
    const SINGULARIZE={"boys":"boy","girls":"girl","students":"student","teachers":"teacher","friends":"friend","cats":"cat","dogs":"dog","books":"book","apples":"apple"};
    s = s.replace(/\b(I|he|she|it)\s+(am|is)\s+([a-z]+(?:\s+[a-z]+)*)?\s*\b([a-z]+s)\b/gi,
      (m,subj,be,adj="",plural)=>{
        const low=plural.toLowerCase(); if(!SINGULARIZE[low]) return m;
        const adjPart=adj?adj.trim()+" ":""; c++;
        return `${subj} ${be} a ${adjPart}${SINGULARIZE[low]}`;
    });

    return {text:s,count:c};
  }

  // äº‹ä»¶
  ui.zh2en.addEventListener('click',async()=>{const txt=ui.inputZh.value.trim();if(!txt)return;
    setStatus("ç¿»è­¯ä¸­â€¦");ui.outputEn.value=await translateSmart(txt,"zh-en");setStatus("âœ… ä¸­æ–‡â†’è‹±æ–‡");});
  ui.en2zh.addEventListener('click',async()=>{const txt=ui.outputEn.value.trim();if(!txt)return;
    setStatus("ç¿»è­¯ä¸­â€¦");ui.outputEn.value=await translateSmart(txt,"en-zh");setStatus("âœ… è‹±æ–‡â†’ä¸­æ–‡");});
  ui.check.addEventListener('click',async()=>{const txt=ui.outputEn.value.trim();if(!txt)return;
    const res=localFixOnce(txt);ui.outputEn.value=res.text;setStatus("âœ… Grammar ä¿®æ­£ "+res.count+" é …");});
})();
</script>
</body>
</html>
