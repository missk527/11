<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Miss K English class</title>

<style>
/* Kids Yellow Theme — inline override（節錄） */
:root{
  --kids-bg:#FFF7CC; --kids-panel:#FFE680; --kids-panel-2:#FFEF99;
  --kids-accent:#FFB703; --kids-accent-2:#FB8500; --kids-text:#3A2D00;
  --kids-muted:#6B5600; --kids-border:#FFD259; --kids-shadow:0 6px 18px rgba(160,120,0,.18);
  --kids-radius:12px;
}
body{ background:var(--kids-bg)!important; color:var(--kids-text)!important;
  font-family:"Comic Sans MS","Noto Sans TC","Microsoft JhengHei",system-ui,Arial,sans-serif!important; line-height:1.6; }
header{ background:linear-gradient(180deg,var(--kids-panel),var(--kids-panel-2))!important;
  border-bottom:2px dashed var(--kids-border)!important; box-shadow:var(--kids-shadow)!important;
  padding:14px 18px; display:flex; justify-content:space-between; align-items:center; }
h1{ color:var(--kids-text)!important; font-size:18px; margin:0; } h1::before{ content:"🦁"; margin-right:6px; }
.btn{ padding:10px 14px!important; border:2px solid var(--kids-border)!important; border-radius:20px!important;
  background:#fff8d9!important; color:var(--kids-text)!important; box-shadow:var(--kids-shadow)!important; font-weight:700!important; }
.btn.primary{ background:var(--kids-accent)!important; border-color:var(--kids-accent-2)!important; color:#1b1100!important; }
textarea{ width:100%; height:220px; border-radius:14px!important; border:2px solid var(--kids-border)!important;
  background:#fffef5!important; color:var(--kids-text)!important; font-size:15px!important; padding:10px; }
#status{ border:2px dashed var(--kids-border)!important; border-radius:var(--kids-radius)!important;
  background:#fff7d1!important; color:var(--kids-text)!important; box-shadow:var(--kids-shadow)!important; padding:12px; margin:18px; }
.grid{ display:grid; gap:14px; margin:18px; } @media(min-width:800px){ .grid{ grid-template-columns:1fr 1fr; } }
.panel{ background:#fffbea; border:2px solid var(--kids-border); border-radius:var(--kids-radius); padding:14px; box-shadow:var(--kids-shadow); }
label{ display:block; margin-bottom:8px; font-weight:900; color:var(--kids-muted); }

/* 高亮樣式 */
.hl-container{ border:2px dashed var(--kids-border); border-radius:12px; padding:12px; background:#fffef7; }
.hl-line{ margin:6px 0; }
.hl-del{ background:#ffe3e3; text-decoration:line-through; border-radius:6px; padding:0 2px; }
.hl-ins{ background:#ddf8dd; border-bottom:2px solid #2d8a2d; border-radius:6px; padding:0 2px; }
.small{ font-size:13px; color:#5f4b00; }
#review{ display:none; }
#review .title{ display:flex; justify-content:space-between; align-items:center; }
#review .toggle{ cursor:pointer; font-weight:700; }
ol.suggest{ padding-left:20px; }
body::after{ content:" 🐻🐰🦊 一起學語言！ "; position:fixed; right:10px; bottom:10px; background:#fff;
  border:2px solid var(--kids-border); border-radius:14px; padding:8px 10px; box-shadow:var(--kids-shadow); font-weight:800; color:var(--kids-text); }
</style>
</head>

<body>
<header>
  <h1>Miss K EnglishClass</h1>
  
</header>

<div class="grid">
  <div class="panel">
    <label>中文</label>
    <textarea id="inputZh" placeholder="輸入中文"></textarea>
    <div class="row">
      <button id="btnZhEn" class="btn primary">中文 ➜ 英文</button>
      <button id="btnClearZh" class="btn">清空</button>
    </div>
  </div>

  <div class="panel">
    <label>English</label>
    <textarea id="outputEn" placeholder="翻譯結果"></textarea>
    <div class="row">
      <button id="btnEnZh" class="btn primary">英文 ➜ 中文(繁體)</button>
      <button id="btnCheck" class="btn">Grammar</button>
      <button id="btnClearEn" class="btn">清空</button>
    </div>
  </div>
</div>

<div id="status">✨ 直接輸入中文或英文即可。</div>

<!-- 修正細節 -->
<div id="review" class="panel">
  <div class="title">
    <strong>🛠 修正細節</strong>
    <button id="btnToggleReview" class="btn">收合/展開</button>
  </div>
  <p class="small">上方顯示「原句（高亮）」與「修正文」。紅色刪除，綠色新增。</p>
  <div class="hl-container">
    <div class="hl-line"><strong>原句：</strong> <span id="origHL"></span></div>
    <div class="hl-line"><strong>修正文：</strong> <span id="corrHL"></span></div>
  </div>
  <h4>建議清單</h4>
  <ol id="suggestList" class="suggest"></ol>
</div>

<script>
(function(){
  const ui = {
    inputZh: document.getElementById('inputZh'),
    outputEn: document.getElementById('outputEn'),
    zh2en: document.getElementById('btnZhEn'),
    en2zh: document.getElementById('btnEnZh'),
    check: document.getElementById('btnCheck'),
    clearZh: document.getElementById('btnClearZh'),
    clearEn: document.getElementById('btnClearEn'),
    status: document.getElementById('status'),
    save: document.getElementById('btnSave'),
    diag: document.getElementById('btnDiag'),
    review: document.getElementById('review'),
    btnToggleReview: document.getElementById('btnToggleReview'),
    origHL: document.getElementById('origHL'),
    corrHL: document.getElementById('corrHL'),
    suggestList: document.getElementById('suggestList')
  };

  function setStatus(msg){ ui.status.textContent = msg; }

  async function libreTranslate(text, target){
    const res = await fetch("https://libretranslate.de/translate", {
      method:"POST", headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ q:text, source:"auto", target:target, format:"text" })
    });
    if(!res.ok) throw new Error("HTTP "+res.status);
    const data = await res.json();
    return data.translatedText;
  }
  async function myMemory(text, source, target){
    const url=`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${source}|${target}`;
    const r=await fetch(url); const j=await r.json();
    return j?.responseData?.translatedText || "";
  }
  async function translateSmart(text, dir){
    try{
      return await libreTranslate(text, dir==="zh-en"?"en":"zh-TW");
    }catch(e){
      setStatus("⚠️ 重新輸入。");
      return await myMemory(text, dir==="zh-en"?"zh-CN":"en", dir==="zh-en"?"en":"zh-TW");
    }
  }

  // ==== Grammar with highlight ====
  function applySuggestionsFromEnd(src, matches){
    const ms = matches.filter(m => m.replacements && m.replacements.length)
                      .sort((a,b)=> (b.offset) - (a.offset));
    let out = src;
    for(const m of ms){
      const rep = m.replacements[0].value;
      out = out.slice(0, m.offset) + rep + out.slice(m.offset + m.length);
    }
    return out;
  }

  function buildHighlightFromMatches(original, matches){
    // 以 matches 產生「原句高亮」：原文字 + <ins>建議</ins>
    let html = "", cursor = 0;
    const sorted = [...matches].sort((a,b)=>a.offset - b.offset);
    for(const m of sorted){
      const start = m.offset, end = m.offset + m.length;
      const rep = (m.replacements && m.replacements[0]) ? m.replacements[0].value : "";
      html += escapeHTML(original.slice(cursor, start));
      const oldPart = escapeHTML(original.slice(start, end));
      const newPart = escapeHTML(rep);
      html += `<span class="hl-del">${oldPart}</span>` + (newPart ? ` <span class="hl-ins">${newPart}</span>` : "");
      cursor = end;
    }
    html += escapeHTML(original.slice(cursor));
    return html;
  }

  function buildSimpleDiff(oldText, newText){
    // Fallback：找出首末差異區塊，做一次替換高亮（簡單但頗直覺）
    if(oldText === newText) return {orig: escapeHTML(oldText), corr: escapeHTML(newText)};
    let s = 0, eOld = oldText.length - 1, eNew = newText.length - 1;
    while(s <= eOld && s <= eNew && oldText[s] === newText[s]) s++;
    while(eOld >= s && eNew >= s && oldText[eOld] === newText[eNew]){ eOld--; eNew--; }
    const orig = escapeHTML(oldText.slice(0,s)) +
                 `<span class="hl-del">${escapeHTML(oldText.slice(s,eOld+1))}</span>` +
                 escapeHTML(oldText.slice(eOld+1));
    const corr = escapeHTML(newText.slice(0,s)) +
                 `<span class="hl-ins">${escapeHTML(newText.slice(s,eNew+1))}</span>` +
                 escapeHTML(newText.slice(eNew+1));
    return {orig, corr};
  }

  function escapeHTML(s){
    return s.replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[c]));
  }

  async function grammarCheck(text){
    if(!text || !text.trim()) return text;

    try{
      // 調 LanguageTool
      const p=new URLSearchParams();
      p.append("text",text);
      p.append("language","en-US");
      p.append("enabledCategories","GRAMMAR,CONFUSED_WORDS,TYPOGRAPHY,PUNCTUATION");
      const r=await fetch("https://api.languagetool.org/v2/check", {
        method:"POST", headers:{"Content-Type":"application/x-www-form-urlencoded"}, body:p
      });
      if(!r.ok) throw new Error("HTTP "+r.status);
      const j=await r.json();

      if(!j.matches || !j.matches.length){
        // 無建議：顯示原句
        ui.origHL.innerHTML = escapeHTML(text);
        ui.corrHL.innerHTML = escapeHTML(text);
        ui.suggestList.innerHTML = "<li>沒有發現需要修改的地方 🎉</li>";
        ui.review.style.display = "block";
        return text;
      }

      // 1) 產生修正文
      const corrected = applySuggestionsFromEnd(text, j.matches);

      // 2) 原句高亮（顯示舊→新）
      ui.origHL.innerHTML = buildHighlightFromMatches(text, j.matches);

      // 3) 修正文高亮（單純顯示修正文）
      ui.corrHL.innerHTML = escapeHTML(corrected);

      // 4) 建議清單
      ui.suggestList.innerHTML = j.matches.map(m=>{
        const rep = (m.replacements && m.replacements[0]) ? m.replacements[0].value : "";
        const bad = escapeHTML(text.substr(m.offset, m.length));
        const msg = escapeHTML(m.message || "");
        const rule = escapeHTML((m.rule && (m.rule.description || m.rule.id)) || "Suggestion");
        return `<li><strong>${rule}</strong>：${msg}<br>
          <span class="small">→ <span class="hl-del">${bad}</span> 改為 <span class="hl-ins">${escapeHTML(rep)}</span></span></li>`;
      }).join("");

      ui.review.style.display = "block";
      setStatus("✅ 完成：Grammar check（修正 "+j.matches.length+" 處）");
      return corrected;

    }catch(e){
      // API 失敗：用簡單規則修一下，並做簡單高亮
      const lf = localFix(text);
      const diff = buildSimpleDiff(text, lf.text);
      ui.origHL.innerHTML = diff.orig;
      ui.corrHL.innerHTML = diff.corr;
      ui.suggestList.innerHTML = `<li>離線簡易修正，共 ${lf.count} 處。</li>`;
      ui.review.style.display = "block";
      setStatus("⚠️ 離線 Grammar：已套用簡易修正 "+lf.count+" 處");
      return lf.text;
    }
  }

  function localFix(src){
    let s = src, c = 0;
    const rules = [
      {re:/\b(him|her|them)\s+([A-Za-z]+)\b/g, fn:(m,p1,p2)=>{ c++; return (p1=='him'?'his':p1=='her'?'her':'their')+' '+p2; }},
      {re:/\b(a)\s+([aeiouAEIOU])/g, fn:(m,a,v)=>{ c++; return 'an '+v; }},
      {re:/\b(an)\s+([^aeiouAEIOU\s])/g, fn:(m,an,cons)=>{ c++; return 'a '+cons; }},
      {re:/ {2,}/g, fn:()=>{ c++; return ' '; }},
      {re:/\b(you|they)\s+was\b/gi, fn:(m,subj)=>{ c++; return subj+' were'; }},
      {re:/(^|[.!?]\s+)([a-z])/g, fn:(m,pre,ch)=>{ c++; return pre+ch.toUpperCase(); }}
    ];
    for(const r of rules){ s = s.replace(r.re, r.fn); }
    return { text: s, count: c };
  }

  // ==== UI 綁定 ====
  ui.zh2en.addEventListener('click', async()=>{ 
    const txt=ui.inputZh.value.trim(); if(!txt) return;
    setStatus("翻譯中（中→英）…");
    ui.outputEn.value=await translateSmart(txt,"zh-en");
    setStatus("✅ 完成：中文→英文");
  });
  ui.en2zh.addEventListener('click', async()=>{
    const txt=ui.outputEn.value.trim(); if(!txt) return;
    setStatus("翻譯中（英→繁體中文）…");
    ui.outputEn.value=await translateSmart(txt,"en-zh");
    setStatus("✅ 完成：英文→中文(繁體)");
  });
  ui.check.addEventListener('click', async()=>{
    const txt=ui.outputEn.value.trim(); if(!txt) return;
    setStatus("文法檢查中…");
    ui.outputEn.value=await grammarCheck(txt);
  });
  ui.clearZh.addEventListener('click',()=>ui.inputZh.value="");
  ui.clearEn.addEventListener('click',()=>ui.outputEn.value="");
  ui.save.addEventListener('click',()=>{
    const blob=new Blob([document.documentElement.outerHTML],{type:"text/html;charset=utf-8"});
    const url=URL.createObjectURL(blob);
    const a=document.createElement("a"); a.href=url; a.download="translator-kids-highlight.html"; a.click();
    URL.revokeObjectURL(url);
  });
  ui.diag.addEventListener('click', async()=>{
    try{
      const r=await fetch("https://libretranslate.de/");
      setStatus("診斷：LibreTranslate "+(r.ok?"可用":"失敗")+" | HTTP "+r.status);
    }catch(e){ setStatus("診斷：請求失敗"); }
  });

  ui.btnToggleReview.addEventListener('click', ()=>{
    ui.review.classList.toggle('closed');
    ui.review.style.display = (ui.review.style.display==='none'?'block':'none');
  });
})();
</script>
</body>
</html>
